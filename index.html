<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o J16 - Cloud Edition</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B35;
            --secondary: #004E89;
            --accent: #F7B801;
            --success: #06D6A0;
            --danger: #EF476F;
            --dark: #0A1128;
            --light: #F7F9FB;
            --gray: #6C757D;
            --border: #DEE2E6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Mono', monospace;
            background: linear-gradient(135deg, #0A1128 0%, #1a2847 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: rgba(255, 107, 53, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--primary);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-family: 'Syne', sans-serif;
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: -1px;
        }

        .logo span {
            color: var(--accent);
        }

        nav {
            display: flex;
            gap: 30px;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--light);
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 5px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--primary);
            transform: translateY(-2px);
        }

        /* Dashboard Cards */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
            animation: fadeIn 0.8s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
        }

        .stat-card:nth-child(2)::before { background: var(--success); }
        .stat-card:nth-child(3)::before { background: var(--accent); }
        .stat-card:nth-child(4)::before { background: var(--secondary); }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
        }

        .stat-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--gray);
            margin-bottom: 6px;
        }

        .stat-value {
            font-family: 'Syne', sans-serif;
            font-size: 22px;
            font-weight: 800;
            color: var(--light);
            margin-bottom: 4px;
            line-height: 1.1;
        }

        .stat-change {
            font-size: 10px;
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-family: 'Syne', sans-serif;
            font-size: 32px;
            font-weight: 800;
            color: var(--primary);
            margin: 40px 0 20px;
            text-transform: uppercase;
            letter-spacing: -1px;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.03);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent);
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: var(--light);
            padding: 12px 15px;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }

        input::placeholder {
            color: var(--gray);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn:hover {
            background: #ff8555;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-secondary:hover {
            background: #006bb3;
        }

        /* Table */
        .table-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            overflow-x: auto;
            border: 2px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background: rgba(255, 107, 53, 0.2);
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent);
            font-weight: 600;
            white-space: nowrap;
        }

        td {
            padding: 15px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 13px;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .badge-success {
            background: var(--success);
            color: var(--dark);
        }

        .badge-warning {
            background: var(--accent);
            color: var(--dark);
        }

        .badge-danger {
            background: var(--danger);
            color: white;
        }

        /* Charts */
        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            min-height: 300px;
        }

        .chart-title {
            font-family: 'Syne', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: width 1s ease;
            border-radius: 10px;
        }

        /* Analysis Grid */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .analysis-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 18px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 12px;
            color: var(--gray);
        }

        .metric-value {
            font-family: 'Syne', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--light);
        }

        /* Delete button */
        .btn-delete {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Space Mono', monospace;
            white-space: nowrap;
        }

        .btn-delete:hover {
            background: #d63456;
            transform: translateY(-2px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            nav {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .logo {
                font-size: 20px;
            }

            .stat-value {
                font-size: 22px;
            }

            .section-title {
                font-size: 24px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 11px;
            }

            th, td {
                padding: 8px 5px;
            }

            .btn-delete {
                padding: 5px 8px;
                font-size: 10px;
                display: block;
                margin: 3px 0;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }

            .metric-value {
                font-size: 14px;
            }

            .chart-title {
                font-size: 12px;
            }
        }

        @media (min-width: 1400px) {
            .dashboard {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .analysis-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Loading Animation */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { 
                transform: translateX(400px);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from { 
                transform: translateX(0);
                opacity: 1;
            }
            to { 
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Export button */
        .btn-export {
            background: var(--success);
            float: right;
        }

        .btn-export:hover {
            background: #05c090;
        }

        /* Infla√ß√£o Input */
        .inflacao-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .inflacao-month {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .inflacao-month label {
            font-size: 11px;
            margin-bottom: 5px;
        }

        .inflacao-month input {
            width: 100%;
            padding: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">J16 <span>TRACKER</span></div>
            <nav>
                <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
                <button class="nav-btn" onclick="showSection('compras')">Compras</button>
                <button class="nav-btn" onclick="showSection('vendas')">Vendas</button>
                <button class="nav-btn" onclick="showSection('parcelas')">Parcelas</button>
                <button class="nav-btn" onclick="showSection('analise')">An√°lise</button>
            </nav>
            <div id="cloudStatus" style="display: flex; align-items: center; gap: 10px; font-size: 11px;">
                <span id="cloudBadge" style="padding: 5px 10px; border-radius: 20px; background: rgba(108, 117, 125, 0.3); color: var(--gray);">
                    ‚òÅÔ∏è Offline
                </span>
                <span id="cloudUser" style="color: var(--gray); display: none;"></span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- DASHBOARD SECTION -->
        <section id="dashboard" class="section active">
            <div class="dashboard">
                <div class="stat-card">
                    <div class="stat-label">Investimento Total</div>
                    <div class="stat-value" id="totalInvestido">R$ 0,00</div>
                    <div class="stat-change" id="changeInvestido">Capital investido</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Faturamento Total</div>
                    <div class="stat-value" id="totalReceita">R$ 0,00</div>
                    <div class="stat-change" id="changeReceita">Receita bruta</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Lucro Total</div>
                    <div class="stat-value" id="totalLucro">R$ 0,00</div>
                    <div class="stat-change" id="changeLucro">Lucro bruto</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ROI</div>
                    <div class="stat-value" id="totalROI">0%</div>
                    <div class="stat-change" id="changeROI">Retorno investimento</div>
                </div>
            </div>

            <div class="analysis-grid">
                <div class="analysis-card">
                    <div class="chart-title">üìä Performance Operacional</div>
                    <div class="metric">
                        <span class="metric-label">Unidades Compradas</span>
                        <span class="metric-value" id="unidadesCompradas">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Unidades Vendidas</span>
                        <span class="metric-value" id="unidadesVendidas">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Estoque Atual</span>
                        <span class="metric-value" id="estoqueAtual">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Taxa de Giro</span>
                        <span class="metric-value" id="taxaGiro">0%</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <div class="chart-title">üí∞ An√°lise Financeira</div>
                    <div class="metric">
                        <span class="metric-label">Margem Bruta</span>
                        <span class="metric-value" id="margemBruta">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Ticket M√©dio</span>
                        <span class="metric-value" id="ticketMedio">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Lucro do M√™s</span>
                        <span class="metric-value" id="lucroMesDashboard">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Lucro Total</span>
                        <span class="metric-value" id="lucroTotalDashboard">R$ 0</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <div class="chart-title">üìà Recebimentos</div>
                    <div class="metric">
                        <span class="metric-label">Total Recebido</span>
                        <span class="metric-value" id="totalRecebido">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total a Receber</span>
                        <span class="metric-value" id="totalAReceber">R$ 0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressRecebimento" style="width: 0%"></div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">% Recebido</span>
                        <span class="metric-value" id="percentRecebido">0%</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <div class="chart-title">üìä M√©tricas Adicionais</div>
                    <div class="metric">
                        <span class="metric-label">Valor em Estoque</span>
                        <span class="metric-value" id="valorEstoque">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">ROI Real (c/ infla√ß√£o)</span>
                        <span class="metric-value" id="roiReal">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Lucro M√©dio/Venda</span>
                        <span class="metric-value" id="lucroMedioVenda">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Lucro Real</span>
                        <span class="metric-value" id="lucroReal">R$ 0</span>
                    </div>
                </div>
            </div>

            <button class="btn btn-export" onclick="exportarDados()">üì• Exportar Dados JSON</button>
            <button class="btn btn-export" onclick="importarDados()" style="margin-left: 10px; background: var(--accent);">üì§ Importar Dados JSON</button>
            <input type="file" id="fileImport" accept=".json" style="display: none;" onchange="processarImportacao(event)">
            <button class="btn btn-secondary" onclick="limparDados()" style="float: right; margin-right: 10px; background: var(--danger);">üóëÔ∏è Limpar Todos os Dados</button>
            
            <!-- Bot√µes Cloud -->
            <button class="btn btn-cloud" onclick="fazerBackupCloud()" style="background: linear-gradient(135deg, var(--success), var(--secondary)); margin-left: 10px;">‚òÅÔ∏è Backup para Cloud</button>
            <button class="btn btn-cloud" onclick="restaurarDaCloud()" style="background: linear-gradient(135deg, var(--accent), var(--primary)); margin-left: 10px;">üì• Restaurar da Cloud</button>
            <button class="btn btn-cloud" onclick="verificarStatusCloud()" style="background: rgba(255,255,255,0.1); margin-left: 10px;">üìä Status Cloud</button>
        </section>

        <!-- COMPRAS SECTION -->
        <section id="compras" class="section">
            <h2 class="section-title">üì¶ Cadastro de Compras</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Data da Compra</label>
                    <input type="date" id="dataCompra" required>
                </div>
                <div class="form-group">
                    <label>Quantidade</label>
                    <input type="number" id="qtdCompra" placeholder="50" min="1" required>
                </div>
                <div class="form-group">
                    <label>Valor Unit√°rio (R$)</label>
                    <input type="number" id="valorUnitCompra" placeholder="180.00" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Fornecedor</label>
                    <input type="text" id="fornecedor" placeholder="Nome do fornecedor">
                </div>
            </div>
            
            <button class="btn" onclick="adicionarCompra()">+ Adicionar Compra</button>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Quantidade</th>
                            <th>Valor Unit.</th>
                            <th>Valor Total</th>
                            <th>Fornecedor</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCompras"></tbody>
                </table>
            </div>
        </section>

        <!-- VENDAS SECTION -->
        <section id="vendas" class="section">
            <h2 class="section-title">üíµ Cadastro de Vendas</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Data da Venda</label>
                    <input type="date" id="dataVenda" required>
                </div>
                <div class="form-group">
                    <label>Quantidade</label>
                    <input type="number" id="qtdVenda" placeholder="10" min="1" required>
                </div>
                <div class="form-group">
                    <label>Valor Unit√°rio (R$)</label>
                    <input type="number" id="valorUnitVenda" placeholder="350.00" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Cliente</label>
                    <input type="text" id="cliente" placeholder="Nome do cliente">
                </div>
                <div class="form-group">
                    <label>Tipo de Pagamento</label>
                    <select id="tipoPagamento" onchange="toggleParcelas()">
                        <option value="vista">√Ä Vista</option>
                        <option value="parcelado">Parcelado</option>
                    </select>
                </div>
                <div class="form-group" id="parcelasGroup" style="display: none;">
                    <label>N√∫mero de Parcelas</label>
                    <input type="number" id="numParcelas" placeholder="6" min="1" max="12">
                </div>
                <div class="form-group" id="jurosGroup" style="display: none;">
                    <label>Taxa de Juros (%)</label>
                    <input type="number" id="taxaJuros" placeholder="3.5" step="0.1" min="0">
                </div>
            </div>
            
            <button class="btn" onclick="adicionarVenda()">+ Adicionar Venda</button>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Quantidade</th>
                            <th>Valor Unit.</th>
                            <th>Valor Total</th>
                            <th>Cliente</th>
                            <th>Tipo Pgto</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaVendas"></tbody>
                </table>
            </div>
        </section>

        <!-- PARCELAS SECTION -->
        <section id="parcelas" class="section">
            <h2 class="section-title">üìã Controle de Parcelas</h2>
            
            <!-- Bot√£o de Corre√ß√£o -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                <button class="btn" onclick="corrigirParcelasProblem√°ticas()" style="background: var(--accent); max-width: 300px;">
                    üîß Corrigir Parcelas com Problema
                </button>
                <button class="btn" onclick="recarregarParcelas()" style="background: var(--secondary); max-width: 200px;">
                    üîÑ Recarregar
                </button>
            </div>

            <div class="analysis-grid" style="margin-bottom: 30px;">
                <div class="analysis-card">
                    <div class="chart-title">Resumo de Parcelas</div>
                    <div class="metric">
                        <span class="metric-label">Total de Parcelas</span>
                        <span class="metric-value" id="totalParcelas">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Parcelas Pagas</span>
                        <span class="metric-value" id="parcelasPagas">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Parcelas Pendentes</span>
                        <span class="metric-value" id="parcelasPendentes">0</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <div class="chart-title">üíµ Fluxo Mensal</div>
                    <div class="metric">
                        <span class="metric-label">Pr√≥ximo Vencimento</span>
                        <span class="metric-value" id="proximoVencimento">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Valor do Pr√≥ximo M√™s</span>
                        <span class="metric-value" id="valorProximoMes">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Lucro do Pr√≥ximo M√™s</span>
                        <span class="metric-value" id="lucroProximoMes">R$ 0</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <div class="chart-title">üìä An√°lise de Lucro</div>
                    <div class="metric">
                        <span class="metric-label">Lucro Total a Receber</span>
                        <span class="metric-value" id="lucroTotalReceber">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Margem M√©dia Parcelas</span>
                        <span class="metric-value" id="margemMediaParcelas">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Lucro J√° Recebido</span>
                        <span class="metric-value" id="lucroRecebido">R$ 0</span>
                    </div>
                </div>
            </div>

            <!-- Calend√°rio de Vencimentos Mensais -->
            <div class="chart-container" style="margin-top: 30px;">
                <div class="chart-title">üí∞ Resumo Mensal de Recebimentos</div>
                <p style="color: var(--gray); margin-bottom: 20px; font-size: 12px;">
                    Total a receber por m√™s (parcelas pendentes agrupadas)
                </p>
                <div id="resumoMensal" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;"></div>
            </div>

            <!-- Calend√°rio de Vencimentos Mensais -->
            <div class="chart-container">
                <div class="chart-title">üìÖ Calend√°rio de Recebimentos Mensais</div>
                <div id="calendarioMensal" style="display: grid; gap: 15px;"></div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Parcela</th>
                            <th>Vencimento</th>
                            <th>Valor Parcela</th>
                            <th>Custo Unit.</th>
                            <th>Lucro Unit.</th>
                            <th>Lucro %</th>
                            <th>Lucro Total</th>
                            <th>Data Pgto</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaParcelas"></tbody>
                </table>
            </div>
        </section>

        <!-- INFLA√á√ÉO SECTION -->
        <section id="inflacao" class="section">
            <h2 class="section-title">üìä An√°lise de Infla√ß√£o (IPCA)</h2>
            
            <p style="color: var(--gray); margin-bottom: 20px;">
                Insira os √≠ndices mensais do IPCA para calcular o impacto da infla√ß√£o no seu neg√≥cio.
                Fonte: <a href="https://www.ibge.gov.br/estatisticas/economicas/precos-e-custos/9256-indice-nacional-de-precos-ao-consumidor-amplo.html" target="_blank" style="color: var(--accent);">IBGE</a>
            </p>

            <div class="inflacao-grid">
                <div class="inflacao-month">
                    <label>Jan/2024</label>
                    <input type="number" step="0.01" placeholder="0.42" id="ipca-0" onchange="calcularInflacao()">
                </div>
                <div class="inflacao-month">
                    <label>Fev/2024</label>
                    <input type="number" step="0.01" placeholder="0.83" id="ipca-1" onchange="calcularInflacao()">
                </div>
                <div class="inflacao-month">
                    <label>Mar/2024</label>
                    <input type="number" step="0.01" placeholder="0.16" id="ipca-2" onchange="calcularInflacao()">
                </div>
                <div class="inflacao-month">
                    <label>Abr/2024</label>
                    <input type="number" step="0.01" placeholder="0.38" id="ipca-3" onchange="calcularInflacao()">
                </div>
                <div class="inflacao-month">
                    <label>Mai/2024</label>
                    <input type="number" step="0.01" placeholder="0.46" id="ipca-4" onchange="calcularInflacao()">
                </div>
                <div class="inflacao-month">
                    <label>Jun/2024</label>
                    <input type="number" step="0.01" placeholder="0.21" id="ipca-5" onchange="calcularInflacao()">
                </div>
                <div class="inflacao-month">
                    <label>Jul/2024</label>
                    <input type="number" step="0.01" placeholder="0.38" id="ipca-6" onchange="calcularInflacao()">
                </div>
                <div class="inflacao-month">
                    <label>Ago/2024</label>
                    <input type="number" step="0.01" placeholder="-0.02" id="ipca-7" onchange="calcularInflacao()">
                </div>
                <div class="inflacao-month">
                    <label>Set/2024</label>
                    <input type="number" step="0.01" placeholder="0.44" id="ipca-8" onchange="calcularInflacao()">
                </div>
                <div class="inflacao-month">
                    <label>Out/2024</label>
                    <input type="number" step="0.01" placeholder="0.56" id="ipca-9" onchange="calcularInflacao()">
                </div>
                <div class="inflacao-month">
                    <label>Nov/2024</label>
                    <input type="number" step="0.01" placeholder="0.39" id="ipca-10" onchange="calcularInflacao()">
                </div>
                <div class="inflacao-month">
                    <label>Dez/2024</label>
                    <input type="number" step="0.01" placeholder="0.52" id="ipca-11" onchange="calcularInflacao()">
                </div>
            </div>

            <div class="analysis-grid" style="margin-top: 30px;">
                <div class="analysis-card">
                    <div class="chart-title">Impacto Calculado</div>
                    <div class="metric">
                        <span class="metric-label">Infla√ß√£o Acumulada 2024</span>
                        <span class="metric-value" id="inflacaoTotal">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Investimento Original</span>
                        <span class="metric-value" id="investimentoOriginal">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Custo Corrigido (Infla√ß√£o)</span>
                        <span class="metric-value" id="custoCorrigidoInflacao">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Perda de Poder de Compra</span>
                        <span class="metric-value" id="perdaPoderCompra" style="color: var(--danger);">R$ 0</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- AN√ÅLISE SECTION -->
        <section id="analise" class="section">
            <h2 class="section-title">üìà An√°lise Completa</h2>

            <!-- Gr√°fico Principal - Evolu√ß√£o Mensal -->
            <div class="chart-container">
                <div class="chart-title">üìä Evolu√ß√£o Mensal - √öltimos 12 Meses</div>
                <canvas id="graficoEvolucao" style="max-height: 300px; margin-top: 20px;"></canvas>
            </div>

            <!-- Gr√°fico Comparativo de Barras -->
            <div class="chart-container" style="margin-top: 30px;">
                <div class="chart-title">Comparativo: Investimento vs Receita vs Lucro</div>
                <div style="display: flex; gap: 20px; align-items: flex-end; height: 250px; margin-top: 30px;">
                    <div style="flex: 1; text-align: center;">
                        <div style="background: var(--danger); height: 0%; width: 100%; border-radius: 10px 10px 0 0; transition: height 1s ease;" id="barInvestimento"></div>
                        <div style="margin-top: 10px; font-size: 12px; color: var(--gray);">INVESTIMENTO</div>
                        <div style="font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; margin-top: 5px;" id="valorBarInvestimento">R$ 0</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="background: var(--success); height: 0%; width: 100%; border-radius: 10px 10px 0 0; transition: height 1s ease;" id="barReceita"></div>
                        <div style="margin-top: 10px; font-size: 12px; color: var(--gray);">RECEITA</div>
                        <div style="font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; margin-top: 5px;" id="valorBarReceita">R$ 0</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="background: var(--accent); height: 0%; width: 100%; border-radius: 10px 10px 0 0; transition: height 1s ease;" id="barLucro"></div>
                        <div style="margin-top: 10px; font-size: 12px; color: var(--gray);">LUCRO</div>
                        <div style="font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; margin-top: 5px;" id="valorBarLucro">R$ 0</div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de Pizza - Composi√ß√£o da Receita -->
            <div class="analysis-grid" style="margin-top: 30px;">
                <div class="chart-container">
                    <div class="chart-title">üç∞ Composi√ß√£o da Receita</div>
                    <canvas id="graficoPizza" style="max-height: 250px; margin-top: 20px;"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">üìà Tend√™ncia de Vendas (6 meses)</div>
                    <canvas id="graficoTendencia" style="max-height: 250px; margin-top: 20px;"></canvas>
                </div>
            </div>

            <!-- Cards de Indicadores -->
            <div class="analysis-grid" style="margin-top: 30px;">
                <div class="analysis-card">
                    <div class="chart-title">üéØ Indicadores de Performance</div>
                    <div class="metric">
                        <span class="metric-label">ROI (Retorno sobre Investimento)</span>
                        <span class="metric-value" id="analiseROI">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Margem de Lucro</span>
                        <span class="metric-value" id="analiseMargem">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Markup M√©dio</span>
                        <span class="metric-value" id="analiseMarkup">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Ticket M√©dio</span>
                        <span class="metric-value" id="analiseTicketMedio">R$ 0</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <div class="chart-title">üì¶ Gest√£o de Estoque</div>
                    <div class="metric">
                        <span class="metric-label">Estoque Inicial</span>
                        <span class="metric-value" id="analiseEstoqueInicial">0 un</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Unidades Vendidas</span>
                        <span class="metric-value" id="analiseVendidas">0 un</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Estoque Atual</span>
                        <span class="metric-value" id="analiseEstoqueAtual">0 un</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Taxa de Giro</span>
                        <span class="metric-value" id="analiseTaxaGiro">0%</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <div class="chart-title">üí∞ An√°lise Financeira</div>
                    <div class="metric">
                        <span class="metric-label">Receita Total</span>
                        <span class="metric-value" id="analiseReceitaTotal">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Lucro Total</span>
                        <span class="metric-value" id="analiseLucroTotal">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Lucro do M√™s</span>
                        <span class="metric-value" id="analiseLucroMes">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">M√©dia Mensal</span>
                        <span class="metric-value" id="analiseMediaMensal">R$ 0</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <div class="chart-title">üí∏ Fluxo de Caixa</div>
                    <div class="metric">
                        <span class="metric-label">Entrada Total (Recebido)</span>
                        <span class="metric-value" id="analiseEntrada">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">A Receber (Pendente)</span>
                        <span class="metric-value" id="analiseAReceber">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Capital Investido</span>
                        <span class="metric-value" id="analiseSaida">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Saldo Operacional</span>
                        <span class="metric-value" id="analiseSaldo">R$ 0</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <div class="chart-title">üìä M√©tricas de Vendas</div>
                    <div class="metric">
                        <span class="metric-label">Total de Vendas</span>
                        <span class="metric-value" id="analiseTotalVendas">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Vendas √† Vista</span>
                        <span class="metric-value" id="analiseVendasVista">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Vendas Parceladas</span>
                        <span class="metric-value" id="analiseVendasParceladas">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">% Parcelamento</span>
                        <span class="metric-value" id="analisePercParcelamento">0%</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <div class="chart-title">‚è±Ô∏è Velocidade de Vendas</div>
                    <div class="metric">
                        <span class="metric-label">Tempo M√©dio em Estoque</span>
                        <span class="metric-value" id="analiseTempoEstoque">- dias</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Vendas por Dia</span>
                        <span class="metric-value" id="analiseVendasDia">0 un/dia</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Prazo para Esgotar</span>
                        <span class="metric-value" id="analisePrazoEsgotar">- dias</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Status Estoque</span>
                        <span class="metric-value" id="analiseStatusEstoque">-</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <div class="chart-title">üìÖ An√°lise Temporal</div>
                    <div class="metric">
                        <span class="metric-label">Dias em Opera√ß√£o</span>
                        <span class="metric-value" id="analiseDiasOperacao">0 dias</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Receita Di√°ria M√©dia</span>
                        <span class="metric-value" id="analiseReceitaDiaria">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Lucro Di√°rio M√©dio</span>
                        <span class="metric-value" id="analiseLucroDiario">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Crescimento Mensal</span>
                        <span class="metric-value" id="analiseCrescimento">0%</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <div class="chart-title">üí≥ An√°lise de Pagamentos</div>
                    <div class="metric">
                        <span class="metric-label">Prazo M√©dio Recebimento</span>
                        <span class="metric-value" id="analisePrazoMedio">0 dias</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Inadimpl√™ncia</span>
                        <span class="metric-value" id="analiseInadimplencia">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Parcelas Vencidas</span>
                        <span class="metric-value" id="analiseParcelasVencidas">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Taxa Adimpl√™ncia</span>
                        <span class="metric-value" id="analiseTaxaAdimplencia">100%</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <div class="chart-title">üéØ Metas e Proje√ß√µes</div>
                    <div class="metric">
                        <span class="metric-label">Meta Mensal Sugerida</span>
                        <span class="metric-value" id="analiseMetaMensal">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Proje√ß√£o Lucro Anual</span>
                        <span class="metric-value" id="analiseProjecaoAnual">R$ 0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Tempo para Breakeven</span>
                        <span class="metric-value" id="analiseBreakeven">- meses</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Efici√™ncia Operacional</span>
                        <span class="metric-value" id="analiseEficiencia">0%</span>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de Evolu√ß√£o do Lucro -->
            <div class="chart-container" style="margin-top: 30px;">
                <div class="chart-title">üìà Evolu√ß√£o do Lucro (√öltimos 6 Meses)</div>
                <canvas id="graficoLucroMensal" style="max-height: 300px; margin-top: 20px;"></canvas>
            </div>

            <!-- Grid com 2 gr√°ficos menores -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-top: 30px;">
                <div class="chart-container">
                    <div class="chart-title">üç∞ Distribui√ß√£o de Vendas</div>
                    <canvas id="graficoDistribuicao" style="max-height: 250px; margin-top: 20px;"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">üìä Performance por Per√≠odo</div>
                    <canvas id="graficoPerformance" style="max-height: 250px; margin-top: 20px;"></canvas>
                </div>
            </div>

            <!-- Rastreamento Correios -->
            <div class="chart-container" style="margin-top: 30px;">
                <div class="chart-title">üìÆ Rastreamento Correios</div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="font-size: 11px; color: var(--gray); margin-bottom: 5px; display: block;">C√≥digo de Rastreio</label>
                    <div style="display: flex; gap: 10px;">
                        <input 
                            type="text" 
                            id="codigoRastreio" 
                            placeholder="AA123456789BR" 
                            style="flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: var(--light); font-family: 'Space Mono', monospace; text-transform: uppercase;"
                            maxlength="13"
                        >
                        <button 
                            onclick="rastrearEncomenda()" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, var(--accent), var(--primary)); border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: 700; font-size: 12px;"
                        >
                            üîç Rastrear
                        </button>
                    </div>
                </div>
                <div id="resultadoRastreio" style="margin-top: 15px; font-size: 11px; max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; padding: 20px; color: var(--gray);">
                        Digite um c√≥digo de rastreio dos Correios
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <script>
        // ==========================================
        // RASTREAMENTO CORREIOS
        // ==========================================
        
        async function rastrearEncomenda() {
            const codigo = document.getElementById('codigoRastreio').value.trim().toUpperCase();
            const resultado = document.getElementById('resultadoRastreio');
            
            if (!codigo) {
                resultado.innerHTML = '<div style="color: var(--danger); padding: 10px;">‚ùå Digite um c√≥digo de rastreio!</div>';
                return;
            }
            
            // Validar formato do c√≥digo
            const regex = /^[A-Z]{2}[0-9]{9}[A-Z]{2}$/;
            if (!regex.test(codigo)) {
                resultado.innerHTML = '<div style="color: var(--danger); padding: 10px;">‚ùå C√≥digo inv√°lido! Formato: AA123456789BR</div>';
                return;
            }
            
            resultado.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--accent);">üîÑ Rastreando encomenda...</div>';
            
            try {
                // API 1: Tentar API p√∫blica brasileira
                let response = await fetch(`https://api.trackingmore.com/v4/trackings/realtime?tracking_number=${codigo}&courier_code=correios-br`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Tracking-Api-Key': 'b84d8c69-9d01-45c0-a1d5-276d4ef2bdc4'
                    }
                });
                
                if (!response.ok) {
                    // Tentar API 2: CEPABerto
                    response = await fetch(`https://cepaberto.com.br/api/v3/track?codigo=${codigo}`, {
                        headers: {
                            'Authorization': 'Token token=f1d711e0b1f6f108'
                        }
                    });
                }
                
                if (!response.ok) {
                    // Tentar API 3: Linketrack
                    response = await fetch(`https://api.linketrack.com/track/json?user=teste&token=1abcd00b2731640e886fb41a8a9671ad1434c599dbaa0a0de9a5aa619f29a83f&codigo=${codigo}`);
                }
                
                const data = await response.json();
                
                // Processar resposta Linketrack
                if (data.quantidade !== undefined) {
                    if (data.quantidade === 0 || !data.eventos || data.eventos.length === 0) {
                        resultado.innerHTML = `
                            <div style="color: var(--danger); padding: 10px;">
                                ‚ùå Nenhum evento encontrado.<br>
                                <span style="font-size: 10px;">O c√≥digo pode estar incorreto ou ainda n√£o foi postado.</span>
                            </div>
                        `;
                        return;
                    }
                    
                    // Montar timeline dos eventos
                    let html = `
                        <div style="background: rgba(6, 214, 160, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 10px; border-left: 3px solid var(--success);">
                            <div style="font-weight: 700; color: var(--success); margin-bottom: 5px;">üì¶ ${codigo}</div>
                            <div style="color: var(--light); font-size: 10px;">Status: ${data.eventos[0].status}</div>
                        </div>
                        <div style="font-weight: 700; margin-bottom: 10px; color: var(--accent); font-size: 11px;">üìç Hist√≥rico de Movimenta√ß√£o:</div>
                    `;
                    
                    data.eventos.forEach((evento, index) => {
                        const isFirst = index === 0;
                        const bgColor = isFirst ? 'rgba(247, 184, 1, 0.1)' : 'rgba(255, 255, 255, 0.03)';
                        const borderColor = isFirst ? 'var(--accent)' : 'rgba(255, 255, 255, 0.1)';
                        
                        html += `
                            <div style="background: ${bgColor}; border-left: 3px solid ${borderColor}; padding: 8px; margin-bottom: 6px; border-radius: 3px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                    <span style="font-weight: 700; color: var(--light); font-size: 11px;">${evento.status}</span>
                                    <span style="color: var(--gray); font-size: 9px;">${evento.data} ${evento.hora}</span>
                                </div>
                                ${evento.local ? `<div style="color: var(--gray); font-size: 10px;">üìç ${evento.local}</div>` : ''}
                                ${evento.origem ? `<div style="color: var(--gray); font-size: 9px;">üîπ De: ${evento.origem}</div>` : ''}
                                ${evento.destino ? `<div style="color: var(--gray); font-size: 9px;">üîπ Para: ${evento.destino}</div>` : ''}
                                ${evento.observacao ? `<div style="color: var(--gray); font-size: 9px; margin-top: 3px;">${evento.observacao}</div>` : ''}
                            </div>
                        `;
                    });
                    
                    resultado.innerHTML = html;
                    return;
                }
                
                // Se nenhuma API funcionou
                throw new Error('APIs indispon√≠veis');
                
            } catch (error) {
                console.error('Erro ao rastrear:', error);
                
                // Solu√ß√£o alternativa: abrir site dos Correios
                resultado.innerHTML = `
                    <div style="padding: 10px;">
                        <div style="color: var(--danger); margin-bottom: 15px;">
                            ‚ùå N√£o foi poss√≠vel consultar via API.<br>
                            <span style="font-size: 10px;">As APIs podem estar temporariamente indispon√≠veis.</span>
                        </div>
                        <div style="background: rgba(247, 184, 1, 0.1); padding: 15px; border-radius: 5px; border: 1px solid var(--accent);">
                            <div style="font-weight: 700; color: var(--accent); margin-bottom: 10px; font-size: 12px;">
                                üì¶ C√≥digo: ${codigo}
                            </div>
                            <a 
                                href="https://rastreamento.correios.com.br/app/index.php" 
                                target="_blank"
                                style="display: inline-block; background: linear-gradient(135deg, var(--accent), var(--primary)); color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: 700; font-size: 11px; margin-top: 5px;"
                            >
                                üîó Rastrear no Site dos Correios
                            </a>
                            <div style="margin-top: 10px; font-size: 9px; color: var(--gray);">
                                Cole o c√≥digo <strong>${codigo}</strong> no site oficial
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Permitir rastrear ao pressionar Enter
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('codigoRastreio');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        rastrearEncomenda();
                    }
                });
            }
        });

        // ==========================================
        // SINCRONIZA√á√ÉO AUTOM√ÅTICA COM CLOUD
        // ==========================================
        
        // Carregar dados da cloud
        async function carregarDadosDaCloud() {
            if (!supabaseClient || !usuarioCloud) {
                console.log('‚ö†Ô∏è N√£o conectado √† cloud');
                return false;
            }
            
            try {
                console.log('üì• Baixando dados da cloud...');
                
                // Carregar Compras
                const { data: comprasCloud, error: comprasError } = await supabaseClient
                    .from('compras')
                    .select('*')
                    .eq('user_id', usuarioCloud.id);
                
                if (!comprasError && comprasCloud) {
                    compras = comprasCloud.map(c => ({
                        id: c.id,
                        data: c.data,
                        quantidade: c.quantidade,
                        valorUnitario: c.valor_unitario,
                        valorTotal: c.valor_total,
                        fornecedor: c.fornecedor
                    }));
                    localStorage.setItem('compras', JSON.stringify(compras));
                }
                
                // Carregar Vendas
                const { data: vendasCloud, error: vendasError } = await supabaseClient
                    .from('vendas')
                    .select('*')
                    .eq('user_id', usuarioCloud.id);
                
                if (!vendasError && vendasCloud) {
                    vendas = vendasCloud.map(v => ({
                        id: v.id,
                        data: v.data,
                        quantidade: v.quantidade,
                        valorUnitario: v.valor_unitario,
                        valorTotal: v.valor_total,
                        cliente: v.cliente,
                        tipoPagamento: v.tipo_pagamento,
                        numParcelas: v.num_parcelas,
                        taxaJuros: v.taxa_juros,
                        status: v.status
                    }));
                    localStorage.setItem('vendas', JSON.stringify(vendas));
                }
                
                // Carregar Parcelas
                const { data: parcelasCloud, error: parcelasError } = await supabaseClient
                    .from('parcelas')
                    .select('*')
                    .eq('user_id', usuarioCloud.id);
                
                if (!parcelasError && parcelasCloud) {
                    parcelas = parcelasCloud.map(p => ({
                        id: p.id,
                        vendaId: p.venda_id,
                        cliente: p.cliente,
                        numeroParcela: p.numero_parcela,
                        totalParcelas: p.total_parcelas,
                        valor: p.valor,
                        custoUnitario: p.custo_unitario,
                        custoParcela: p.custo_parcela,
                        lucroParcela: p.lucro_parcela,
                        margemParcela: p.margem_parcela,
                        quantidadeVendida: p.quantidade_vendida,
                        vencimento: p.vencimento,
                        dataPagamento: p.data_pagamento,
                        status: p.status
                    }));
                    localStorage.setItem('parcelas', JSON.stringify(parcelas));
                }
                
                console.log('‚úÖ Dados carregados da cloud:', {
                    compras: compras.length,
                    vendas: vendas.length,
                    parcelas: parcelas.length
                });
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar da cloud:', error);
                return false;
            }
        }
        
        // Salvar compra na cloud automaticamente
        async function salvarCompraNaCloud(compra) {
            if (!supabaseClient || !usuarioCloud) return;
            
            try {
                const { error } = await supabaseClient
                    .from('compras')
                    .upsert({
                        id: compra.id,
                        data: compra.data,
                        quantidade: compra.quantidade,
                        valor_unitario: compra.valorUnitario,
                        valor_total: compra.valorTotal,
                        fornecedor: compra.fornecedor || null,
                        user_id: usuarioCloud.id
                    });
                
                if (error) throw error;
                console.log('‚òÅÔ∏è Compra salva na cloud:', compra.id);
            } catch (error) {
                console.error('‚ùå Erro ao salvar compra na cloud:', error);
            }
        }
        
        // Salvar venda na cloud automaticamente
        async function salvarVendaNaCloud(venda) {
            if (!supabaseClient || !usuarioCloud) return;
            
            try {
                const { error } = await supabaseClient
                    .from('vendas')
                    .upsert({
                        id: venda.id,
                        data: venda.data,
                        quantidade: venda.quantidade,
                        valor_unitario: venda.valorUnitario,
                        valor_total: venda.valorTotal,
                        cliente: venda.cliente || null,
                        tipo_pagamento: venda.tipoPagamento,
                        num_parcelas: venda.numParcelas,
                        taxa_juros: venda.taxaJuros,
                        status: venda.status,
                        user_id: usuarioCloud.id
                    });
                
                if (error) throw error;
                console.log('‚òÅÔ∏è Venda salva na cloud:', venda.id);
            } catch (error) {
                console.error('‚ùå Erro ao salvar venda na cloud:', error);
            }
        }
        
        // Salvar parcela na cloud automaticamente
        async function salvarParcelaNaCloud(parcela) {
            if (!supabaseClient || !usuarioCloud) return;
            
            try {
                const { error } = await supabaseClient
                    .from('parcelas')
                    .upsert({
                        id: parcela.id,
                        venda_id: parcela.vendaId,
                        cliente: parcela.cliente || null,
                        numero_parcela: parcela.numeroParcela,
                        total_parcelas: parcela.totalParcelas,
                        valor: parcela.valor,
                        custo_unitario: parcela.custoUnitario || null,
                        custo_parcela: parcela.custoParcela || null,
                        lucro_parcela: parcela.lucroParcela || null,
                        margem_parcela: parcela.margemParcela || null,
                        quantidade_vendida: parcela.quantidadeVendida || null,
                        vencimento: parcela.vencimento,
                        data_pagamento: parcela.dataPagamento || null,
                        status: parcela.status,
                        user_id: usuarioCloud.id
                    });
                
                if (error) throw error;
                console.log('‚òÅÔ∏è Parcela salva na cloud:', parcela.id);
            } catch (error) {
                console.error('‚ùå Erro ao salvar parcela na cloud:', error);
            }
        }
        
        // Deletar da cloud
        async function deletarDaCloud(tabela, id) {
            if (!supabaseClient || !usuarioCloud) return;
            
            try {
                const { error } = await supabaseClient
                    .from(tabela)
                    .delete()
                    .eq('id', id)
                    .eq('user_id', usuarioCloud.id);
                
                if (error) throw error;
                console.log(`‚òÅÔ∏è ${tabela} deletado da cloud:`, id);
            } catch (error) {
                console.error(`‚ùå Erro ao deletar ${tabela} da cloud:`, error);
            }
        }

        // ==========================================
        // FIM DA SINCRONIZA√á√ÉO AUTOM√ÅTICA
        // ==========================================
        
        // ==========================================
        // FUN√á√ïES B√ÅSICAS (definidas primeiro)
        // ==========================================
        
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(s => s.classList.remove('active'));
            
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(b => b.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Atualizar dados ao mudar de se√ß√£o
            if (sectionId === 'dashboard' || sectionId === 'analise') {
                atualizarDashboard();
            }
            if (sectionId === 'analise') {
                // Criar gr√°ficos com delay para garantir que canvas est√° pronto
                setTimeout(() => {
                    criarGraficos();
                }, 100);
            }
            if (sectionId === 'parcelas') {
                renderizarParcelas();
            }
        }

        // ==========================================
        // CONFIGURA√á√ÉO SUPABASE (Cloud Backup)
        // ==========================================
        
        const SUPABASE_URL = 'https://gwyvwuoogznhphcmvjus.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3eXZ3dW9vZ3puaHBoY212anVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MjczMzMsImV4cCI6MjA4NjEwMzMzM30.7VWyCPjzKv1l10sLCewPM-E08-FdAP-oxMMbfLfFbxc';
        
        var supabaseClient = null;
        var usuarioCloud = null;
        
        // Inicializar Supabase quando dispon√≠vel
        function inicializarSupabase() {
            try {
                if (typeof window.supabase !== 'undefined') {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('‚òÅÔ∏è Supabase Cloud Backup ativado!');
                    
                    // Verificar se est√° logado no cloud
                    supabaseClient.auth.getSession().then(({ data: { session } }) => {
                        if (session) {
                            usuarioCloud = session.user;
                            console.log('‚úÖ Conectado √† cloud como:', usuarioCloud.email);
                            
                            // Atualizar badge de status
                            atualizarStatusCloud('online', usuarioCloud.email);
                            
                            if (typeof mostrarNotificacao === 'function') {
                                mostrarNotificacao('‚úÖ Sincroniza√ß√£o autom√°tica ativada!');
                            }
                        } else {
                            console.log('‚ÑπÔ∏è Cloud dispon√≠vel - fa√ßa login para sincroniza√ß√£o autom√°tica');
                            atualizarStatusCloud('offline');
                        }
                    }).catch(err => {
                        console.warn('‚ö†Ô∏è Erro ao verificar sess√£o:', err.message);
                        atualizarStatusCloud('offline');
                    });
                } else {
                    console.warn('‚ö†Ô∏è SDK Supabase n√£o carregado - sincroniza√ß√£o cloud desabilitada');
                    atualizarStatusCloud('offline');
                }
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Supabase:', error);
                atualizarStatusCloud('offline');
            }
        }
        
        // Atualizar badge visual de status da cloud
        function atualizarStatusCloud(status, email = null) {
            const badge = document.getElementById('cloudBadge');
            const userEl = document.getElementById('cloudUser');
            
            if (!badge) return;
            
            if (status === 'online' && email) {
                badge.innerHTML = '‚òÅÔ∏è Online';
                badge.style.background = 'linear-gradient(135deg, var(--success), var(--secondary))';
                badge.style.color = 'white';
                
                if (userEl) {
                    userEl.textContent = email.split('@')[0];
                    userEl.style.display = 'block';
                }
            } else if (status === 'syncing') {
                badge.innerHTML = 'üîÑ Sincronizando...';
                badge.style.background = 'linear-gradient(135deg, var(--accent), var(--primary))';
                badge.style.color = 'white';
            } else {
                badge.innerHTML = '‚òÅÔ∏è Offline';
                badge.style.background = 'rgba(108, 117, 125, 0.3)';
                badge.style.color = 'var(--gray)';
                
                if (userEl) {
                    userEl.style.display = 'none';
                }
            }
        }
        
        // Inicializar ap√≥s DOM carregar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarSupabase);
        } else {
            setTimeout(inicializarSupabase, 100);
        }

        // ==========================================
        // DATA STORAGE (LocalStorage - Offline First)
        // ==========================================
        
        // Data storage usando LocalStorage para funcionar offline
        let compras = [];
        let vendas = [];
        let parcelas = [];
        let inflacao = Array(12).fill(0);
        let percentualImpostos = 0;

        // Fun√ß√£o para inicializar dados
        async function inicializarDados() {
            console.log('üîÑ Inicializando dados...');
            
            // Verificar se est√° logado no Supabase
            if (supabaseClient && usuarioCloud) {
                console.log('‚òÅÔ∏è Usu√°rio logado, carregando dados da cloud...');
                await carregarDadosDaCloud();
                return;
            }
            
            // Se n√£o estiver logado, carregar do localStorage
            console.log('üíæ Carregando dados do localStorage...');
            
            // Tentar carregar do localStorage
            try {
                const comprasStr = localStorage.getItem('compras');
                if (comprasStr && comprasStr !== 'undefined' && comprasStr !== 'null') {
                    const parsed = JSON.parse(comprasStr);
                    if (Array.isArray(parsed)) {
                        compras = parsed;
                    }
                }
            } catch (e) {
                console.error('Erro ao carregar compras:', e);
                compras = [];
            }

            try {
                const vendasStr = localStorage.getItem('vendas');
                if (vendasStr && vendasStr !== 'undefined' && vendasStr !== 'null') {
                    const parsed = JSON.parse(vendasStr);
                    if (Array.isArray(parsed)) {
                        vendas = parsed;
                    }
                }
            } catch (e) {
                console.error('Erro ao carregar vendas:', e);
                vendas = [];
            }

            try {
                const parcelasStr = localStorage.getItem('parcelas');
                if (parcelasStr && parcelasStr !== 'undefined' && parcelasStr !== 'null') {
                    const parsed = JSON.parse(parcelasStr);
                    if (Array.isArray(parsed)) {
                        parcelas = parsed;
                        
                        // üîß CORRE√á√ÉO: Limpar IDs decimais e duplicados
                        let corrigido = false;
                        parcelas.forEach((p, index) => {
                            // Converter IDs decimais em inteiros
                            if (!Number.isInteger(p.id)) {
                                console.warn(`‚ö†Ô∏è Parcela ${index} com ID decimal:`, p.id, '‚Üí Corrigindo para:', Math.floor(p.id));
                                p.id = Math.floor(p.id);
                                corrigido = true;
                            }
                            
                            // Garantir que campos essenciais existem
                            if (!p.status) {
                                p.status = 'Pendente';
                                corrigido = true;
                            }
                            if (!p.vencimento) {
                                console.error('‚ùå Parcela sem vencimento:', p);
                            }
                        });
                        
                        // Verificar IDs duplicados
                        const idsUnicos = new Set();
                        const duplicados = [];
                        parcelas.forEach(p => {
                            if (idsUnicos.has(p.id)) {
                                duplicados.push(p.id);
                            }
                            idsUnicos.add(p.id);
                        });
                        
                        if (duplicados.length > 0) {
                            console.warn('‚ö†Ô∏è IDs duplicados encontrados:', duplicados);
                            // Corrigir IDs duplicados
                            parcelas.forEach(p => {
                                if (duplicados.includes(p.id)) {
                                    const novoId = Date.now() + Math.floor(Math.random() * 1000);
                                    console.log(`üîß Corrigindo ID duplicado ${p.id} ‚Üí ${novoId}`);
                                    p.id = novoId;
                                    corrigido = true;
                                }
                            });
                        }
                        
                        // Salvar corre√ß√µes
                        if (corrigido) {
                            localStorage.setItem('parcelas', JSON.stringify(parcelas));
                            console.log('‚úÖ Parcelas corrigidas e salvas!');
                        }
                    }
                }
            } catch (e) {
                console.error('Erro ao carregar parcelas:', e);
                parcelas = [];
            }

            try {
                const inflacaoStr = localStorage.getItem('inflacao');
                if (inflacaoStr && inflacaoStr !== 'undefined' && inflacaoStr !== 'null') {
                    const parsed = JSON.parse(inflacaoStr);
                    if (Array.isArray(parsed)) {
                        inflacao = parsed;
                    }
                }
            } catch (e) {
                console.error('Erro ao carregar infla√ß√£o:', e);
                inflacao = Array(12).fill(0);
            }

            try {
                const impostosStr = localStorage.getItem('percentualImpostos');
                if (impostosStr && impostosStr !== 'undefined' && impostosStr !== 'null') {
                    percentualImpostos = parseFloat(impostosStr) || 0;
                }
            } catch (e) {
                console.error('Erro ao carregar impostos:', e);
                percentualImpostos = 0;
            }

            // Adicionar dados de exemplo APENAS se estiver completamente vazio
            // N√£o sobrescrever dados existentes do usu√°rio
            if (compras.length === 0 && vendas.length === 0 && parcelas.length === 0) {
                console.log('Sistema vazio. Adicionando dados de exemplo b√°sicos...');
                compras = [
                    {
                        id: 1738800000000,
                        data: '2024-01-15',
                        quantidade: 100,
                        valorUnitario: 180.00,
                        valorTotal: 18000.00,
                        fornecedor: 'Fornecedor Exemplo'
                    }
                ];
                localStorage.setItem('compras', JSON.stringify(compras));
                console.log('Dados de exemplo criados. Use "Limpar Todos os Dados" no Dashboard se quiser resetar.');
            } else {
                console.log('‚úÖ Dados do usu√°rio detectados e carregados:');
                console.log('  - Compras:', compras.length);
                console.log('  - Vendas:', vendas.length);
                console.log('  - Parcelas:', parcelas.length);
                
                // Mostrar resumo dos dados reais
                if (compras.length > 0) {
                    const totalUnidades = compras.reduce((acc, c) => acc + c.quantidade, 0);
                    const totalInvestido = compras.reduce((acc, c) => acc + c.valorTotal, 0);
                    console.log(`  üì¶ Total de rastreadores comprados: ${totalUnidades}`);
                    console.log(`  üí∞ Total investido: R$ ${totalInvestido.toFixed(2)}`);
                }
                
                if (vendas.length > 0) {
                    const totalVendido = vendas.reduce((acc, v) => acc + v.quantidade, 0);
                    const totalReceita = vendas.reduce((acc, v) => acc + v.valorTotal, 0);
                    console.log(`  üìä Total de rastreadores vendidos: ${totalVendido}`);
                    console.log(`  üíµ Receita total: R$ ${totalReceita.toFixed(2)}`);
                }
                
                if (parcelas.length > 0) {
                    const parcelasPagas = parcelas.filter(p => p.status === 'Pago').length;
                    const parcelasPendentes = parcelas.filter(p => p.status === 'Pendente').length;
                    console.log(`  ‚úÖ Parcelas pagas: ${parcelasPagas}`);
                    console.log(`  ‚è∏Ô∏è Parcelas pendentes: ${parcelasPendentes}`);
                }
            }

            console.log('Sistema inicializado e pronto para uso!');
        }

        // Inicializar ao carregar a p√°gina
        inicializarDados();

        // Navega√ß√£o (fun√ß√£o j√° definida no in√≠cio do script)

        // Toggle parcelas
        function toggleParcelas() {
            const tipo = document.getElementById('tipoPagamento').value;
            document.getElementById('parcelasGroup').style.display = tipo === 'parcelado' ? 'block' : 'none';
            document.getElementById('jurosGroup').style.display = tipo === 'parcelado' ? 'block' : 'none';
        }

        // Adicionar Compra
        function adicionarCompra() {
            try {
                const data = document.getElementById('dataCompra').value;
                const qtd = parseFloat(document.getElementById('qtdCompra').value);
                const valorUnit = parseFloat(document.getElementById('valorUnitCompra').value);
                const fornecedor = document.getElementById('fornecedor').value;

                // Valida√ß√µes
                if (!data) {
                    alert('Por favor, informe a data da compra!');
                    return;
                }

                if (!qtd || isNaN(qtd) || qtd <= 0) {
                    alert('Por favor, informe uma quantidade v√°lida!');
                    return;
                }

                if (!valorUnit || isNaN(valorUnit) || valorUnit <= 0) {
                    alert('Por favor, informe um valor unit√°rio v√°lido!');
                    return;
                }

                if (compraEditandoId) {
                    // Modo edi√ß√£o
                    const index = compras.findIndex(c => c.id === compraEditandoId);
                    if (index !== -1) {
                        compras[index] = {
                            id: compraEditandoId,
                            data: data,
                            quantidade: qtd,
                            valorUnitario: valorUnit,
                            valorTotal: qtd * valorUnit,
                            fornecedor: fornecedor || ''
                        };
                        
                        // üî• SALVAR NA CLOUD AUTOMATICAMENTE
                        salvarCompraNaCloud(compras[index]);
                    }
                    compraEditandoId = null;
                    
                    // Restaurar bot√£o
                    const btnAdicionar = document.querySelector('#compras .btn');
                    btnAdicionar.textContent = '+ Adicionar Compra';
                    btnAdicionar.style.background = '';
                } else {
                    // Modo adicionar
                    const compra = {
                        id: Date.now(),
                        data: data,
                        quantidade: qtd,
                        valorUnitario: valorUnit,
                        valorTotal: qtd * valorUnit,
                        fornecedor: fornecedor || ''
                    };

                    compras.push(compra);
                    
                    // üî• SALVAR NA CLOUD AUTOMATICAMENTE
                    salvarCompraNaCloud(compra);
                }
                
                // Salvar no localStorage tamb√©m
                localStorage.setItem('compras', JSON.stringify(compras));
                
                // Limpar formul√°rio
                document.getElementById('dataCompra').value = '';
                document.getElementById('qtdCompra').value = '';
                document.getElementById('valorUnitCompra').value = '';
                document.getElementById('fornecedor').value = '';

                // Atualizar visualiza√ß√µes
                renderizarCompras();
                atualizarDashboard();
                
                alert('‚úì Compra salva com sucesso!');
            } catch (error) {
                console.error('Erro ao adicionar compra:', error);
                alert('Erro ao adicionar compra. Verifique o console para mais detalhes.');
            }
        }

        // Renderizar Compras
        function renderizarCompras() {
            const tbody = document.getElementById('tabelaCompras');
            tbody.innerHTML = '';

            // Ordenar por data (mais antigas primeiro = ordem cronol√≥gica crescente)
            const comprasOrdenadas = [...compras].sort((a, b) => new Date(a.data) - new Date(b.data));

            comprasOrdenadas.forEach(c => {
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(c.data).toLocaleDateString('pt-BR')}</td>
                        <td>${c.quantidade}</td>
                        <td>${formatarMoeda(c.valorUnitario)}</td>
                        <td>${formatarMoeda(c.valorTotal)}</td>
                        <td>${c.fornecedor || '-'}</td>
                        <td>
                            <button class="btn-delete" onclick="editarCompra(${c.id})" style="background: var(--accent); margin-right: 5px;">‚úèÔ∏è Editar</button>
                            <button class="btn-delete" onclick="deletarCompra(${c.id})">üóëÔ∏è Excluir</button>
                        </td>
                    </tr>
                `;
            });
        }

        // Deletar Compra
        function deletarCompra(id) {
            if (confirm('Deseja realmente excluir esta compra?')) {
                compras = compras.filter(c => c.id !== id);
                localStorage.setItem('compras', JSON.stringify(compras));
                
                // üî• DELETAR DA CLOUD AUTOMATICAMENTE
                deletarDaCloud('compras', id);
                
                renderizarCompras();
                atualizarDashboard();
            }
        }

        // Editar Compra
        let compraEditandoId = null;

        function editarCompra(id) {
            try {
                const compra = compras.find(c => c.id === id);
                if (!compra) {
                    alert('Compra n√£o encontrada!');
                    return;
                }

                // Marcar que est√° editando
                compraEditandoId = id;

                // Preencher formul√°rio
                document.getElementById('dataCompra').value = compra.data;
                document.getElementById('qtdCompra').value = compra.quantidade;
                document.getElementById('valorUnitCompra').value = compra.valorUnitario;
                document.getElementById('fornecedor').value = compra.fornecedor || '';

                // Mudar texto do bot√£o
                const btnAdicionar = document.querySelector('#compras .btn');
                if (btnAdicionar) {
                    btnAdicionar.textContent = '‚úì Salvar Altera√ß√µes';
                    btnAdicionar.style.background = 'var(--success)';
                }

                // Scroll para o formul√°rio
                document.getElementById('dataCompra').scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                setTimeout(() => {
                    document.getElementById('dataCompra').focus();
                }, 300);
            } catch (error) {
                console.error('Erro ao editar compra:', error);
                alert('Erro ao carregar compra para edi√ß√£o.');
            }
        }

        // Adicionar Venda
        function adicionarVenda() {
            const data = document.getElementById('dataVenda').value;
            const qtd = parseFloat(document.getElementById('qtdVenda').value);
            const valorUnit = parseFloat(document.getElementById('valorUnitVenda').value);
            const cliente = document.getElementById('cliente').value;
            const tipoPgto = document.getElementById('tipoPagamento').value;
            const numParcelas = tipoPgto === 'parcelado' ? parseInt(document.getElementById('numParcelas').value) : 1;
            const taxaJuros = tipoPgto === 'parcelado' ? parseFloat(document.getElementById('taxaJuros').value) || 0 : 0;

            if (!data || !qtd || !valorUnit) {
                alert('Preencha todos os campos obrigat√≥rios!');
                return;
            }

            if (tipoPgto === 'parcelado' && (!numParcelas || numParcelas < 1)) {
                alert('Informe o n√∫mero de parcelas!');
                return;
            }

            if (vendaEditandoId) {
                // Modo edi√ß√£o - atualizar venda existente
                const index = vendas.findIndex(v => v.id === vendaEditandoId);
                if (index !== -1) {
                    // Remover parcelas antigas
                    parcelas = parcelas.filter(p => p.vendaId !== vendaEditandoId);
                    
                    // Atualizar venda
                    vendas[index] = {
                        id: vendaEditandoId,
                        data,
                        quantidade: qtd,
                        valorUnitario: valorUnit,
                        valorTotal: qtd * valorUnit,
                        cliente,
                        tipoPagamento: tipoPgto,
                        numParcelas,
                        taxaJuros,
                        status: tipoPgto === 'vista' ? 'Pago' : 'Parcelado'
                    };

                    // üî• SALVAR VENDA NA CLOUD AUTOMATICAMENTE
                    salvarVendaNaCloud(vendas[index]);

                    // Gerar novas parcelas se for parcelado
                    if (tipoPgto === 'parcelado') {
                        gerarParcelas(vendas[index]);
                    }
                }
                vendaEditandoId = null;
                
                // Restaurar bot√£o
                const btnAdicionar = document.querySelector('#vendas .btn');
                btnAdicionar.textContent = '+ Adicionar Venda';
                btnAdicionar.style.background = 'var(--primary)';
            } else {
                // Modo adicionar - nova venda
                const venda = {
                    id: Date.now(),
                    data,
                    quantidade: qtd,
                    valorUnitario: valorUnit,
                    valorTotal: qtd * valorUnit,
                    cliente,
                    tipoPagamento: tipoPgto,
                    numParcelas,
                    taxaJuros,
                    status: tipoPgto === 'vista' ? 'Pago' : 'Parcelado'
                };

                vendas.push(venda);
                
                // üî• SALVAR VENDA NA CLOUD AUTOMATICAMENTE
                salvarVendaNaCloud(venda);

                // Gerar parcelas se for parcelado
                if (tipoPgto === 'parcelado') {
                    gerarParcelas(venda);
                }
            }

            localStorage.setItem('vendas', JSON.stringify(vendas));
            localStorage.setItem('parcelas', JSON.stringify(parcelas));

            // Limpar formul√°rio
            document.getElementById('dataVenda').value = '';
            document.getElementById('qtdVenda').value = '';
            document.getElementById('valorUnitVenda').value = '';
            document.getElementById('cliente').value = '';
            document.getElementById('tipoPagamento').value = 'vista';
            document.getElementById('numParcelas').value = '';
            document.getElementById('taxaJuros').value = '';
            toggleParcelas();

            renderizarVendas();
            renderizarParcelas();
            atualizarDashboard();
            
            alert('‚úì Venda salva com sucesso! As parcelas foram atualizadas com base na data de venda.');
        }

        // Gerar Parcelas
        function gerarParcelas(venda) {
            // Calcular valor base da parcela (arredondado para 2 casas decimais)
            const valorBaseParcela = Math.floor((venda.valorTotal / venda.numParcelas) * 100) / 100;
            
            // Calcular diferen√ßa de centavos
            const totalCalculado = valorBaseParcela * venda.numParcelas;
            const diferenca = venda.valorTotal - totalCalculado;
            
            console.log('üíµ Calculando parcelas:', {
                valorTotal: venda.valorTotal,
                numParcelas: venda.numParcelas,
                valorBaseParcela: valorBaseParcela,
                diferenca: diferenca,
                ultimaParcela: valorBaseParcela + diferenca
            });
            
            // IMPORTANTE: Adicionar 'T00:00:00' para evitar problemas de timezone
            const dataVenda = new Date(venda.data + 'T00:00:00');
            
            console.log('üìÖ Gerando parcelas baseadas na data de VENDA:', {
                dataVenda: venda.data,
                dataVendaObj: dataVenda.toLocaleDateString('pt-BR'),
                numParcelas: venda.numParcelas
            });
            
            // Buscar custo unit√°rio m√©dio das compras
            const custoUnitMedio = compras.length > 0 
                ? compras.reduce((acc, c) => acc + c.valorTotal, 0) / compras.reduce((acc, c) => acc + c.quantidade, 0)
                : 0;
            
            const custoTotalVenda = custoUnitMedio * venda.quantidade;
            const custoBasePorParcela = Math.floor((custoTotalVenda / venda.numParcelas) * 100) / 100;
            const diferencaCusto = custoTotalVenda - (custoBasePorParcela * venda.numParcelas);

            for (let i = 0; i < venda.numParcelas; i++) {
                // Determinar valor desta parcela
                const isUltimaParcela = (i === venda.numParcelas - 1);
                const valorParcela = isUltimaParcela 
                    ? valorBaseParcela + diferenca  // √öltima parcela ajusta os centavos
                    : valorBaseParcela;
                
                const custoParcela = isUltimaParcela
                    ? custoBasePorParcela + diferencaCusto
                    : custoBasePorParcela;
                
                const lucroParcela = valorParcela - custoParcela;
                const margemParcela = valorParcela > 0 ? (lucroParcela / valorParcela * 100) : 0;
                
                // Calcula vencimento: sempre dia 30
                // Parcela 1: 1 m√™s ap√≥s venda, Parcela 2: 2 meses ap√≥s venda, etc
                const vencimento = new Date(dataVenda);
                
                // Adiciona (i+1) meses √† data da venda
                const novoMes = dataVenda.getMonth() + i + 1;
                const novoAno = dataVenda.getFullYear() + Math.floor(novoMes / 12);
                const mesAjustado = novoMes % 12;
                
                vencimento.setFullYear(novoAno);
                vencimento.setMonth(mesAjustado);
                
                // Define como dia 30
                vencimento.setDate(30);
                
                // Verifica se mudou de m√™s (significa que o m√™s n√£o tem 30 dias)
                if (vencimento.getMonth() !== mesAjustado) {
                    // Volta para o √∫ltimo dia do m√™s correto
                    vencimento.setDate(0);
                }

                const parcela = {
                    id: Date.now() + i + Math.floor(Math.random() * 1000),
                    vendaId: venda.id,
                    cliente: venda.cliente,
                    numeroParcela: i + 1,
                    totalParcelas: venda.numParcelas,
                    valor: valorParcela,
                    custoUnitario: custoUnitMedio,
                    custoParcela: custoParcela,
                    lucroParcela: lucroParcela,
                    margemParcela: margemParcela,
                    quantidadeVendida: venda.quantidade,
                    vencimento: vencimento.toISOString().split('T')[0],
                    dataPagamento: null,
                    status: 'Pendente'
                };

                parcelas.push(parcela);
                
                // üî• SALVAR PARCELA NA CLOUD AUTOMATICAMENTE
                salvarParcelaNaCloud(parcela);
                
                console.log(`  Parcela ${i+1}/${venda.numParcelas}: ${formatarMoeda(valorParcela)} - Vence em ${new Date(parcela.vencimento).toLocaleDateString('pt-BR')}`);
            }

            localStorage.setItem('parcelas', JSON.stringify(parcelas));
            console.log('‚úÖ Parcelas geradas e salvas! Valores iguais exceto √∫ltima que ajusta centavos.');
        }

        // Renderizar Vendas
        function renderizarVendas() {
            const tbody = document.getElementById('tabelaVendas');
            tbody.innerHTML = '';

            // Ordenar por data (mais antigas primeiro = ordem cronol√≥gica crescente)
            const vendasOrdenadas = [...vendas].sort((a, b) => new Date(a.data) - new Date(b.data));

            vendasOrdenadas.forEach(v => {
                const badgeClass = v.status === 'Pago' ? 'badge-success' : 'badge-warning';
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(v.data).toLocaleDateString('pt-BR')}</td>
                        <td>${v.quantidade}</td>
                        <td>${formatarMoeda(v.valorUnitario)}</td>
                        <td>${formatarMoeda(v.valorTotal)}</td>
                        <td>${v.cliente || '-'}</td>
                        <td>${v.tipoPagamento === 'vista' ? '√Ä Vista' : v.numParcelas + 'x'}</td>
                        <td><span class="badge ${badgeClass}">${v.status}</span></td>
                        <td>
                            <button class="btn-delete" onclick="editarVenda(${v.id})" style="background: var(--accent); margin-right: 5px;">‚úèÔ∏è Editar</button>
                            <button class="btn-delete" onclick="deletarVenda(${v.id})">üóëÔ∏è Excluir</button>
                        </td>
                    </tr>
                `;
            });
        }

        // Deletar Venda
        function deletarVenda(id) {
            if (confirm('Deseja realmente excluir esta venda? As parcelas relacionadas tamb√©m ser√£o exclu√≠das.')) {
                vendas = vendas.filter(v => v.id !== id);
                parcelas = parcelas.filter(p => p.vendaId !== id);
                localStorage.setItem('vendas', JSON.stringify(vendas));
                localStorage.setItem('parcelas', JSON.stringify(parcelas));
                renderizarVendas();
                atualizarDashboard();
            }
        }

        // Editar Venda
        let vendaEditandoId = null;

        function editarVenda(id) {
            const venda = vendas.find(v => v.id === id);
            if (!venda) return;

            // Marcar que est√° editando
            vendaEditandoId = id;

            document.getElementById('dataVenda').value = venda.data;
            document.getElementById('qtdVenda').value = venda.quantidade;
            document.getElementById('valorUnitVenda').value = venda.valorUnitario;
            document.getElementById('cliente').value = venda.cliente || '';
            document.getElementById('tipoPagamento').value = venda.tipoPagamento;
            
            toggleParcelas();
            
            if (venda.tipoPagamento === 'parcelado') {
                document.getElementById('numParcelas').value = venda.numParcelas;
                document.getElementById('taxaJuros').value = venda.taxaJuros;
            }

            // Mudar texto do bot√£o
            const btnAdicionar = document.querySelector('#vendas .btn');
            btnAdicionar.textContent = '‚úì Salvar Altera√ß√µes';
            btnAdicionar.style.background = 'var(--success)';

            // Scroll para o formul√°rio
            document.getElementById('dataVenda').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('dataVenda').focus();

            alert('Venda carregada para edi√ß√£o. As parcelas antigas ser√£o substitu√≠das ao salvar.');
        }

        // Renderizar Parcelas
        function renderizarParcelas() {
            const tbody = document.getElementById('tabelaParcelas');
            tbody.innerHTML = '';

            // Ordenar por vencimento
            const parcelasOrdenadas = [...parcelas].sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento));

            parcelasOrdenadas.forEach(p => {
                const badgeClass = p.status === 'Pago' ? 'badge-success' : 
                                  (new Date(p.vencimento) < new Date() ? 'badge-danger' : 'badge-warning');
                
                // Calcular lucro se n√£o existir (para parcelas antigas)
                if (!p.lucroParcela) {
                    const custoUnitMedio = compras.length > 0 
                        ? compras.reduce((acc, c) => acc + c.valorTotal, 0) / compras.reduce((acc, c) => acc + c.quantidade, 0)
                        : 0;
                    const venda = vendas.find(v => v.id === p.vendaId);
                    if (venda) {
                        const custoTotal = custoUnitMedio * venda.quantidade;
                        p.custoParcela = custoTotal / p.totalParcelas;
                        p.lucroParcela = p.valor - p.custoParcela;
                        p.margemParcela = p.valor > 0 ? (p.lucroParcela / p.valor * 100) : 0;
                        p.custoUnitario = custoUnitMedio;
                    }
                }

                const lucroTotal = p.lucroParcela || 0;
                const margemParcela = p.margemParcela || 0;
                const isPago = p.status === 'Pago';
                
                tbody.innerHTML += `
                    <tr style="${isPago ? 'opacity: 0.7; background: rgba(6, 214, 160, 0.05);' : ''}">
                        <td>${p.cliente || '-'}</td>
                        <td><strong>${p.numeroParcela}/${p.totalParcelas}</strong></td>
                        <td>${new Date(p.vencimento).toLocaleDateString('pt-BR')}</td>
                        <td><strong>${formatarMoeda(p.valor)}</strong></td>
                        <td style="color: var(--danger);">${formatarMoeda(p.custoParcela || 0)}</td>
                        <td style="color: var(--success);">${formatarMoeda(p.lucroParcela || 0)}</td>
                        <td style="color: var(--accent);"><strong>${margemParcela.toFixed(1)}%</strong></td>
                        <td style="color: var(--success); font-weight: bold;">${formatarMoeda(lucroTotal)}</td>
                        <td>${p.dataPagamento ? new Date(p.dataPagamento).toLocaleDateString('pt-BR') : '-'}</td>
                        <td>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input 
                                    type="checkbox" 
                                    ${isPago ? 'checked' : ''} 
                                    onchange="togglePagamento(${p.id}, this.checked)"
                                    style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--success);"
                                >
                                <span class="badge ${badgeClass}">${p.status}</span>
                            </label>
                        </td>
                        <td>
                            ${p.status === 'Pendente' ? 
                                `<button class="btn-delete" onclick="marcarComoPago(${p.id})" style="background: var(--success);">‚úì Receber</button>` :
                                `<button class="btn-delete" onclick="marcarComoPendente(${p.id})" style="background: var(--accent);">‚Ü∫ Reverter</button>`
                            }
                        </td>
                    </tr>
                `;
            });

            // Atualizar resumo
            const totalParcelas = parcelas.length;
            const parcelasPagas = parcelas.filter(p => p.status === 'Pago').length;
            const parcelasPendentes = totalParcelas - parcelasPagas;

            document.getElementById('totalParcelas').textContent = totalParcelas;
            document.getElementById('parcelasPagas').textContent = parcelasPagas;
            document.getElementById('parcelasPendentes').textContent = parcelasPendentes;

            // Calcular pr√≥ximo vencimento e valor do pr√≥ximo m√™s
            const hoje = new Date();
            const parcelasPendentesOrdenadas = parcelas
                .filter(p => p.status === 'Pendente' && new Date(p.vencimento) >= hoje)
                .sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento));

            if (parcelasPendentesOrdenadas.length > 0) {
                const proximaParcela = parcelasPendentesOrdenadas[0];
                const proximoVenc = new Date(proximaParcela.vencimento);
                
                // Encontrar todas as parcelas do mesmo m√™s
                const parcelasProximoMes = parcelasPendentesOrdenadas.filter(p => {
                    const venc = new Date(p.vencimento);
                    return venc.getMonth() === proximoVenc.getMonth() && 
                           venc.getFullYear() === proximoVenc.getFullYear();
                });

                const valorProximoMes = parcelasProximoMes.reduce((acc, p) => acc + p.valor, 0);
                const lucroProximoMes = parcelasProximoMes.reduce((acc, p) => acc + (p.lucroParcela || 0), 0);

                document.getElementById('proximoVencimento').textContent = proximoVenc.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                document.getElementById('valorProximoMes').textContent = formatarMoeda(valorProximoMes);
                document.getElementById('lucroProximoMes').textContent = formatarMoeda(lucroProximoMes);
            } else {
                document.getElementById('proximoVencimento').textContent = '-';
                document.getElementById('valorProximoMes').textContent = 'R$ 0';
                document.getElementById('lucroProximoMes').textContent = 'R$ 0';
            }

            // Calcular lucro total a receber e j√° recebido
            const lucroTotalReceber = parcelas
                .filter(p => p.status === 'Pendente')
                .reduce((acc, p) => acc + (p.lucroParcela || 0), 0);
            
            const lucroRecebido = parcelas
                .filter(p => p.status === 'Pago')
                .reduce((acc, p) => acc + (p.lucroParcela || 0), 0);

            const margemMedia = parcelas.length > 0 
                ? parcelas.reduce((acc, p) => acc + (p.margemParcela || 0), 0) / parcelas.length 
                : 0;

            document.getElementById('lucroTotalReceber').textContent = formatarMoeda(lucroTotalReceber);
            document.getElementById('lucroRecebido').textContent = formatarMoeda(lucroRecebido);
            document.getElementById('margemMediaParcelas').textContent = margemMedia.toFixed(1) + '%';

            // Renderizar Resumo Mensal
            renderizarResumoMensal();
            
            // Renderizar calend√°rio mensal
            renderizarCalendarioMensal();
        }

        // Renderizar Resumo Mensal de Recebimentos
        function renderizarResumoMensal() {
            const container = document.getElementById('resumoMensal');
            if (!container) return;
            
            // Filtrar apenas parcelas pendentes
            const parcelasPendentes = parcelas.filter(p => p.status === 'Pendente');
            
            // Agrupar parcelas por m√™s/ano
            const parcelasPorMes = {};
            
            parcelasPendentes.forEach(p => {
                const data = new Date(p.vencimento);
                const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                
                if (!parcelasPorMes[mesAno]) {
                    parcelasPorMes[mesAno] = {
                        data: data,
                        parcelas: [],
                        valorTotal: 0,
                        lucroTotal: 0,
                        quantidade: 0
                    };
                }
                
                parcelasPorMes[mesAno].parcelas.push(p);
                parcelasPorMes[mesAno].valorTotal += p.valor;
                parcelasPorMes[mesAno].lucroTotal += (p.lucroParcela || 0);
                parcelasPorMes[mesAno].quantidade++;
            });
            
            // Ordenar por data
            const mesesOrdenados = Object.keys(parcelasPorMes).sort();
            
            // Calcular total geral
            const totalGeral = mesesOrdenados.reduce((acc, mes) => acc + parcelasPorMes[mes].valorTotal, 0);
            const lucroGeral = mesesOrdenados.reduce((acc, mes) => acc + parcelasPorMes[mes].lucroTotal, 0);
            
            // Gerar HTML
            let html = '';
            
            mesesOrdenados.forEach(mesAno => {
                const dados = parcelasPorMes[mesAno];
                const data = dados.data;
                const mesNome = data.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                const percentualTotal = totalGeral > 0 ? (dados.valorTotal / totalGeral * 100) : 0;
                
                html += `
                    <div style="background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; transition: all 0.3s ease;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="font-size: 16px; font-weight: 700; color: var(--accent); text-transform: capitalize;">
                                üìÖ ${mesNome}
                            </div>
                            <div style="font-size: 12px; color: var(--gray); background: rgba(247, 184, 1, 0.2); padding: 4px 10px; border-radius: 10px;">
                                ${dados.quantidade} parcela${dados.quantidade > 1 ? 's' : ''}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 11px; color: var(--gray); margin-bottom: 5px;">VALOR A RECEBER:</div>
                            <div style="font-size: 28px; font-weight: 800; color: var(--success); font-family: 'Syne', sans-serif;">
                                ${formatarMoeda(dados.valorTotal)}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 11px; color: var(--gray); margin-bottom: 5px;">LUCRO ESTIMADO:</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--accent);">
                                ${formatarMoeda(dados.lucroTotal)}
                            </div>
                        </div>
                        
                        <div style="background: rgba(255, 255, 255, 0.05); height: 6px; border-radius: 3px; overflow: hidden; margin-top: 15px;">
                            <div style="background: linear-gradient(90deg, var(--success), var(--accent)); height: 100%; width: ${percentualTotal}%; transition: width 1s ease;"></div>
                        </div>
                        <div style="font-size: 10px; color: var(--gray); margin-top: 5px; text-align: center;">
                            ${percentualTotal.toFixed(1)}% do total a receber
                        </div>
                    </div>
                `;
            });
            
            // Card de TOTAL GERAL
            if (mesesOrdenados.length > 0) {
                html += `
                    <div style="background: linear-gradient(135deg, rgba(247, 184, 1, 0.2), rgba(255, 107, 53, 0.2)); border: 3px solid var(--accent); border-radius: 15px; padding: 20px; grid-column: 1 / -1;">
                        <div style="text-align: center;">
                            <div style="font-size: 14px; color: var(--gray); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">
                                üí∞ TOTAL A RECEBER (TODOS OS MESES)
                            </div>
                            <div style="font-size: 42px; font-weight: 900; color: var(--success); font-family: 'Syne', sans-serif; margin-bottom: 10px;">
                                ${formatarMoeda(totalGeral)}
                            </div>
                            <div style="font-size: 16px; color: var(--accent); font-weight: 700;">
                                Lucro estimado: ${formatarMoeda(lucroGeral)}
                            </div>
                            <div style="font-size: 12px; color: var(--gray); margin-top: 10px;">
                                ${parcelasPendentes.length} parcela${parcelasPendentes.length > 1 ? 's' : ''} pendente${parcelasPendentes.length > 1 ? 's' : ''} ‚Ä¢ ${mesesOrdenados.length} m√™s${mesesOrdenados.length > 1 ? 'es' : ''}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html = `
                    <div style="text-align: center; padding: 60px; color: var(--gray); grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
                        <div style="font-size: 18px; font-weight: 600;">Nenhuma parcela pendente</div>
                        <div style="font-size: 14px; margin-top: 5px;">Todas as parcelas foram pagas!</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // Renderizar Calend√°rio Mensal
        function renderizarCalendarioMensal() {
            const container = document.getElementById('calendarioMensal');
            container.innerHTML = '';

            // Agrupar parcelas por m√™s
            const parcelasPorMes = {};
            
            parcelas.forEach(p => {
                const venc = new Date(p.vencimento);
                const mesAno = `${venc.getFullYear()}-${String(venc.getMonth() + 1).padStart(2, '0')}`;
                
                if (!parcelasPorMes[mesAno]) {
                    parcelasPorMes[mesAno] = {
                        data: venc,
                        parcelas: [],
                        valorTotal: 0,
                        lucroTotal: 0,
                        pagas: 0,
                        pendentes: 0
                    };
                }
                
                parcelasPorMes[mesAno].parcelas.push(p);
                parcelasPorMes[mesAno].valorTotal += p.valor;
                parcelasPorMes[mesAno].lucroTotal += (p.lucroParcela || 0);
                
                if (p.status === 'Pago') {
                    parcelasPorMes[mesAno].pagas++;
                } else {
                    parcelasPorMes[mesAno].pendentes++;
                }
            });

            // Ordenar por data
            const mesesOrdenados = Object.entries(parcelasPorMes)
                .sort((a, b) => new Date(a[1].data) - new Date(b[1].data));

            if (mesesOrdenados.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 20px;">Nenhuma parcela cadastrada</p>';
                return;
            }

            mesesOrdenados.forEach(([mesAno, dados]) => {
                const mesNome = dados.data.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                const percentPago = dados.parcelas.length > 0 ? (dados.pagas / dados.parcelas.length * 100) : 0;
                
                container.innerHTML += `
                    <div style="background: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <div style="font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; color: var(--accent); text-transform: uppercase;">
                                    ${mesNome}
                                </div>
                                <div style="font-size: 12px; color: var(--gray); margin-top: 5px;">
                                    ${dados.parcelas.length} parcela(s) ‚Ä¢ ${dados.pagas} paga(s) ‚Ä¢ ${dados.pendentes} pendente(s)
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 700; color: var(--light);">
                                    ${formatarMoeda(dados.valorTotal)}
                                </div>
                                <div style="font-size: 14px; color: var(--success); margin-top: 3px;">
                                    Lucro: ${formatarMoeda(dados.lucroTotal)}
                                </div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentPago}%;"></div>
                        </div>
                        <div style="font-size: 12px; color: var(--gray); margin-top: 8px; text-align: right;">
                            ${percentPago.toFixed(0)}% recebido
                        </div>
                    </div>
                `;
            });
        }

        // Marcar como Pago
        function marcarComoPago(id) {
            const parcela = parcelas.find(p => p.id === id);
            if (parcela) {
                parcela.status = 'Pago';
                parcela.dataPagamento = new Date().toISOString().split('T')[0];
                localStorage.setItem('parcelas', JSON.stringify(parcelas));
                
                // üî• ATUALIZAR NA CLOUD AUTOMATICAMENTE
                salvarParcelaNaCloud(parcela);
                
                console.log('‚úÖ Parcela marcada como paga:', {
                    cliente: parcela.cliente,
                    parcela: `${parcela.numeroParcela}/${parcela.totalParcelas}`,
                    valor: parcela.valor,
                    lucro: parcela.lucroParcela,
                    dataPagamento: parcela.dataPagamento
                });
                
                renderizarParcelas();
                atualizarDashboard(); // Atualiza financeiro automaticamente
                
                // Feedback visual
                alert(`‚úì Parcela ${parcela.numeroParcela}/${parcela.totalParcelas} marcada como PAGA!\n\nValor: ${formatarMoeda(parcela.valor)}\nLucro: ${formatarMoeda(parcela.lucroParcela || 0)}\n\nüí∞ Financeiro atualizado!`);
            }
        }

        // Marcar como Pendente
        function marcarComoPendente(id) {
            const parcela = parcelas.find(p => p.id === id);
            if (parcela) {
                if (confirm(`Deseja reverter o pagamento da parcela ${parcela.numeroParcela}/${parcela.totalParcelas}?`)) {
                    parcela.status = 'Pendente';
                    parcela.dataPagamento = null;
                    localStorage.setItem('parcelas', JSON.stringify(parcelas));
                    
                    // üî• ATUALIZAR NA CLOUD AUTOMATICAMENTE
                    salvarParcelaNaCloud(parcela);
                    
                    console.log('‚Ü©Ô∏è Parcela revertida para pendente:', {
                        cliente: parcela.cliente,
                        parcela: `${parcela.numeroParcela}/${parcela.totalParcelas}`
                    });
                    
                    renderizarParcelas();
                    atualizarDashboard(); // Atualiza financeiro automaticamente
                    
                    alert('‚Ü©Ô∏è Parcela revertida para PENDENTE!\n\nüí∞ Financeiro atualizado!');
                }
            }
        }

        // Toggle Pagamento via Checkbox
        function togglePagamento(id, isPago) {
            console.log('üîÑ togglePagamento chamado:', { id, isPago, tipo: typeof id });
            
            // Converter ID para n√∫mero se necess√°rio
            const idNumerico = typeof id === 'string' ? parseInt(id) : id;
            
            const parcela = parcelas.find(p => p.id == id || p.id == idNumerico);
            
            if (!parcela) {
                console.error('‚ùå Parcela n√£o encontrada!', { 
                    idBuscado: id, 
                    idNumerico: idNumerico,
                    parcelasDisponiveis: parcelas.map(p => ({ id: p.id, cliente: p.cliente }))
                });
                alert('Erro: Parcela n√£o encontrada! Recarregue a p√°gina.');
                renderizarParcelas();
                return;
            }

            console.log('‚úÖ Parcela encontrada:', {
                id: parcela.id,
                cliente: parcela.cliente,
                parcela: `${parcela.numeroParcela}/${parcela.totalParcelas}`,
                statusAnterior: parcela.status,
                novoStatus: isPago ? 'Pago' : 'Pendente'
            });

            if (isPago) {
                // Marcar como pago
                parcela.status = 'Pago';
                parcela.dataPagamento = new Date().toISOString().split('T')[0];
                
                console.log('‚úÖ Parcela marcada como PAGA via checkbox:', {
                    cliente: parcela.cliente,
                    parcela: `${parcela.numeroParcela}/${parcela.totalParcelas}`,
                    valor: formatarMoeda(parcela.valor),
                    lucro: formatarMoeda(parcela.lucroParcela || 0),
                    data: parcela.dataPagamento
                });
                
            } else {
                // Marcar como pendente
                parcela.status = 'Pendente';
                parcela.dataPagamento = null;
                
                console.log('‚è∏Ô∏è Parcela desmarcada (pendente) via checkbox:', {
                    cliente: parcela.cliente,
                    parcela: `${parcela.numeroParcela}/${parcela.totalParcelas}`
                });
            }
            
            // Salvar no localStorage
            localStorage.setItem('parcelas', JSON.stringify(parcelas));
            console.log('üíæ Salvo no localStorage');
            
            // üî• SALVAR NA CLOUD AUTOMATICAMENTE
            if (typeof salvarParcelaNaCloud === 'function' && supabaseClient && usuarioCloud) {
                salvarParcelaNaCloud(parcela);
                console.log('‚òÅÔ∏è Enviado para cloud');
            }
            
            // Atualizar interface
            renderizarParcelas();
            atualizarDashboard();
            console.log('üîÑ Interface atualizada');
            
            // Mostrar notifica√ß√£o r√°pida
            if (typeof mostrarNotificacao === 'function') {
                mostrarNotificacao(isPago ? 
                    `‚úì Parcela ${parcela.numeroParcela}/${parcela.totalParcelas} RECEBIDA! Valor: ${formatarMoeda(parcela.valor)}` : 
                    `‚è∏Ô∏è Parcela ${parcela.numeroParcela}/${parcela.totalParcelas} marcada como PENDENTE`
                );
            }
        }

        // Mostrar notifica√ß√£o r√°pida
        function mostrarNotificacao(mensagem) {
            // Criar elemento de notifica√ß√£o
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, var(--success), var(--accent));
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                font-family: 'Space Mono', monospace;
                font-size: 14px;
                font-weight: bold;
                box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notif.textContent = mensagem;
            document.body.appendChild(notif);

            // Remover ap√≥s 3 segundos
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // Calcular Infla√ß√£o
        function calcularInflacao() {
            inflacao = [];
            for (let i = 0; i < 12; i++) {
                const valor = parseFloat(document.getElementById(`ipca-${i}`).value) || 0;
                inflacao[i] = valor;
            }
            localStorage.setItem('inflacao', JSON.stringify(inflacao));
            atualizarDashboard();
        }

        // üîß Corrigir Parcelas Problem√°ticas
        function corrigirParcelasProblem√°ticas() {
            console.log('üîß Iniciando corre√ß√£o de parcelas...');
            
            let corrigidas = 0;
            let problemas = [];
            
            parcelas.forEach((p, index) => {
                const problema = {
                    index: index,
                    id: p.id,
                    cliente: p.cliente,
                    parcela: `${p.numeroParcela}/${p.totalParcelas}`,
                    issues: []
                };
                
                // Verificar ID decimal
                if (!Number.isInteger(p.id)) {
                    problema.issues.push(`ID decimal: ${p.id}`);
                    p.id = Math.floor(p.id);
                    corrigidas++;
                }
                
                // Verificar status vazio
                if (!p.status || (p.status !== 'Pago' && p.status !== 'Pendente')) {
                    problema.issues.push(`Status inv√°lido: ${p.status}`);
                    p.status = 'Pendente';
                    corrigidas++;
                }
                
                // Verificar vencimento
                if (!p.vencimento) {
                    problema.issues.push('Sem vencimento');
                }
                
                // Verificar valor
                if (!p.valor || p.valor <= 0) {
                    problema.issues.push(`Valor inv√°lido: ${p.valor}`);
                }
                
                if (problema.issues.length > 0) {
                    problemas.push(problema);
                }
            });
            
            // Verificar duplicados
            const idsCount = {};
            parcelas.forEach(p => {
                idsCount[p.id] = (idsCount[p.id] || 0) + 1;
            });
            
            const duplicados = Object.keys(idsCount).filter(id => idsCount[id] > 1);
            
            if (duplicados.length > 0) {
                console.warn('‚ö†Ô∏è IDs duplicados:', duplicados);
                parcelas.forEach(p => {
                    if (duplicados.includes(p.id.toString())) {
                        const novoId = Date.now() + Math.floor(Math.random() * 10000);
                        console.log(`üîß ID duplicado ${p.id} ‚Üí ${novoId}`);
                        p.id = novoId;
                        corrigidas++;
                    }
                });
            }
            
            // Salvar corre√ß√µes
            if (corrigidas > 0) {
                localStorage.setItem('parcelas', JSON.stringify(parcelas));
                console.log('‚úÖ Corre√ß√µes salvas!', {corrigidas, problemas});
                
                // Mostrar relat√≥rio
                let mensagem = `üîß Corre√ß√£o conclu√≠da!\n\n`;
                mensagem += `‚úÖ ${corrigidas} problema(s) corrigido(s)\n`;
                mensagem += `üìä ${parcelas.length} parcelas no total\n\n`;
                
                if (problemas.length > 0) {
                    mensagem += `Problemas encontrados:\n`;
                    problemas.slice(0, 5).forEach(p => {
                        mensagem += `\n‚Ä¢ ${p.cliente} ${p.parcela}:\n`;
                        p.issues.forEach(i => mensagem += `  - ${i}\n`);
                    });
                    if (problemas.length > 5) {
                        mensagem += `\n... e mais ${problemas.length - 5} parcela(s)\n`;
                    }
                }
                
                alert(mensagem);
                
                // Recarregar interface
                renderizarParcelas();
                atualizarDashboard();
                mostrarNotificacao(`‚úì ${corrigidas} parcela(s) corrigida(s)!`);
            } else {
                alert('‚úÖ Nenhum problema encontrado!\n\nTodas as parcelas est√£o OK.');
                console.log('‚úÖ Nenhuma corre√ß√£o necess√°ria');
            }
        }

        // üîÑ Recarregar Parcelas
        function recarregarParcelas() {
            console.log('üîÑ Recarregando parcelas...');
            
            try {
                // Recarregar do localStorage
                const parcelasStr = localStorage.getItem('parcelas');
                if (parcelasStr) {
                    parcelas = JSON.parse(parcelasStr);
                    console.log('‚úÖ Parcelas recarregadas:', parcelas.length);
                }
                
                // Atualizar interface
                renderizarParcelas();
                atualizarDashboard();
                
                mostrarNotificacao(`‚úì ${parcelas.length} parcelas recarregadas!`);
            } catch (e) {
                console.error('‚ùå Erro ao recarregar:', e);
                alert('Erro ao recarregar parcelas: ' + e.message);
            }
        }

        // Salvar Impostos
        function salvarImpostos() {
            const valor = parseFloat(document.getElementById('percentualImpostosInput').value) || 0;
            percentualImpostos = valor;
            localStorage.setItem('percentualImpostos', percentualImpostos.toString());
            console.log('üí∞ Percentual de impostos atualizado:', percentualImpostos + '%');
            atualizarDashboard();
            mostrarNotificacao(`‚úì Impostos configurados: ${percentualImpostos}%`);
        }

        // Atualizar Dashboard
        function atualizarDashboard() {
            // Calcular totais
            const totalInvestido = compras.reduce((acc, c) => acc + c.valorTotal, 0);
            const totalReceita = vendas.reduce((acc, v) => acc + v.valorTotal, 0);
            
            // Calcular unidades
            const unidadesCompradas = compras.reduce((acc, c) => acc + c.quantidade, 0);
            const unidadesVendidas = vendas.reduce((acc, v) => acc + v.quantidade, 0);
            const estoqueAtual = unidadesCompradas - unidadesVendidas;
            const taxaGiro = unidadesCompradas > 0 ? (unidadesVendidas / unidadesCompradas * 100) : 0;
            
            // C√ÅLCULO SIMPLES DO LUCRO:
            // Para cada venda, calcular o lucro real baseado no custo unit√°rio espec√≠fico
            let totalLucro = 0;
            let custoTotalVendas = 0;
            
            // Calcular custo m√©dio unit√°rio de cada compra
            const comprasComCustoUnit = compras.map(c => ({
                ...c,
                custoUnitario: c.valorTotal / c.quantidade,
                qtdRestante: c.quantidade
            }));
            
            // Para cada venda, calcular lucro
            vendas.forEach(venda => {
                const receitaVenda = venda.valorTotal;
                const custoUnitarioMedio = totalInvestido / unidadesCompradas;
                const custoVenda = custoUnitarioMedio * venda.quantidade;
                const lucroVenda = receitaVenda - custoVenda;
                
                totalLucro += lucroVenda;
                custoTotalVendas += custoVenda;
            });
            
            const roi = totalInvestido > 0 ? (totalLucro / totalInvestido * 100) : 0;

            // Calcular recebimentos
            const totalRecebido = parcelas.filter(p => p.status === 'Pago').reduce((acc, p) => acc + p.valor, 0);
            const totalAReceber = parcelas.filter(p => p.status === 'Pendente').reduce((acc, p) => acc + p.valor, 0);
            const percentRecebido = (totalRecebido + totalAReceber) > 0 ? (totalRecebido / (totalRecebido + totalAReceber) * 100) : 0;

            // Atualizar cards principais do dashboard
            document.getElementById('totalInvestido').textContent = formatarMoeda(totalInvestido);
            document.getElementById('totalReceita').textContent = formatarMoeda(totalReceita);
            document.getElementById('totalLucro').textContent = formatarMoeda(totalLucro);
            document.getElementById('totalROI').textContent = roi.toFixed(1) + '%';

            // LOG para debug
            console.log('üìä C√°lculos Dashboard:');
            console.log('  Investimento Total:', formatarMoeda(totalInvestido));
            console.log('  Faturamento Total:', formatarMoeda(totalReceita));
            console.log('  Custo das Vendas:', formatarMoeda(custoTotalVendas));
            console.log('  Lucro Total:', formatarMoeda(totalLucro));
            console.log('  ROI:', roi.toFixed(2) + '%');

            // Atualizar m√©tricas operacionais
            document.getElementById('unidadesCompradas').textContent = unidadesCompradas;
            document.getElementById('unidadesVendidas').textContent = unidadesVendidas;
            document.getElementById('estoqueAtual').textContent = estoqueAtual;
            document.getElementById('taxaGiro').textContent = taxaGiro.toFixed(1) + '%';

            // Atualizar m√©tricas financeiras
            const margemBruta = totalReceita > 0 ? (totalLucro / totalReceita * 100) : 0;
            const ticketMedio = unidadesVendidas > 0 ? (totalReceita / unidadesVendidas) : 0;
            const valorEstoque = unidadesCompradas > 0 ? (totalInvestido / unidadesCompradas * estoqueAtual) : 0;

            document.getElementById('margemBruta').textContent = margemBruta.toFixed(1) + '%';
            document.getElementById('ticketMedio').textContent = formatarMoeda(ticketMedio);
            document.getElementById('valorEstoque').textContent = formatarMoeda(valorEstoque);

            // Atualizar recebimentos
            document.getElementById('totalRecebido').textContent = formatarMoeda(totalRecebido);
            document.getElementById('totalAReceber').textContent = formatarMoeda(totalAReceber);
            document.getElementById('percentRecebido').textContent = percentRecebido.toFixed(1) + '%';
            document.getElementById('progressRecebimento').style.width = percentRecebido + '%';

            // CALCULAR LUCRO DO M√äS ATUAL (baseado em parcelas pagas no m√™s)
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            
            const custoUnitarioMedio = unidadesCompradas > 0 ? (totalInvestido / unidadesCompradas) : 0;
            
            let lucroMesAtual = 0;
            let receitaMesAtual = 0;
            
            parcelas.forEach(p => {
                if (p.status === 'Pago' && p.dataPagamento) {
                    const dataPgto = new Date(p.dataPagamento);
                    if (dataPgto.getMonth() === mesAtual && dataPgto.getFullYear() === anoAtual) {
                        receitaMesAtual += p.valor;
                        // Lucro da parcela j√° calculado
                        lucroMesAtual += (p.lucroParcela || 0);
                    }
                }
            });
            
            // Atualizar lucro do m√™s nos dashboards
            document.getElementById('lucroMesDashboard').textContent = formatarMoeda(lucroMesAtual);
            document.getElementById('lucroTotalDashboard').textContent = formatarMoeda(totalLucro);
            
            // An√°lise completa - preencher TODOS os campos
            document.getElementById('analiseROI').textContent = roi.toFixed(1) + '%';
            document.getElementById('analiseMargem').textContent = margemBruta.toFixed(1) + '%';
            const markup = totalInvestido > 0 ? ((totalReceita - totalInvestido) / totalInvestido * 100) : 0;
            document.getElementById('analiseMarkup').textContent = markup.toFixed(1) + '%';
            document.getElementById('analiseTicketMedio').textContent = formatarMoeda(ticketMedio);

            // Estoque
            document.getElementById('analiseEstoqueInicial').textContent = unidadesCompradas + ' un';
            document.getElementById('analiseVendidas').textContent = unidadesVendidas + ' un';
            document.getElementById('analiseEstoqueAtual').textContent = estoqueAtual + ' un';
            const taxaGiroAnalise = unidadesCompradas > 0 ? (unidadesVendidas / unidadesCompradas * 100) : 0;
            document.getElementById('analiseTaxaGiro').textContent = taxaGiroAnalise.toFixed(1) + '%';

            // An√°lise Financeira
            document.getElementById('analiseReceitaTotal').textContent = formatarMoeda(totalReceita);
            document.getElementById('analiseLucroTotal').textContent = formatarMoeda(totalLucro);
            document.getElementById('analiseLucroMes').textContent = formatarMoeda(lucroMesAtual);
            const mediaMensal = vendas.length > 0 ? totalLucro / Math.max(1, Math.ceil(vendas.length / 30)) : 0;
            document.getElementById('analiseMediaMensal').textContent = formatarMoeda(mediaMensal);

            // Fluxo de Caixa
            document.getElementById('analiseEntrada').textContent = formatarMoeda(totalRecebido);
            document.getElementById('analiseAReceber').textContent = formatarMoeda(totalAReceber);
            document.getElementById('analiseSaida').textContent = formatarMoeda(totalInvestido);
            document.getElementById('analiseSaldo').textContent = formatarMoeda(totalRecebido - totalInvestido);

            // M√©tricas de Vendas
            const totalVendas = vendas.length;
            const vendasVista = vendas.filter(v => v.tipoPagamento === 'vista').length;
            const vendasParceladas = vendas.filter(v => v.tipoPagamento === 'parcelado').length;
            const percParcelamento = totalVendas > 0 ? (vendasParceladas / totalVendas * 100) : 0;
            
            document.getElementById('analiseTotalVendas').textContent = totalVendas;
            document.getElementById('analiseVendasVista').textContent = vendasVista;
            document.getElementById('analiseVendasParceladas').textContent = vendasParceladas;
            document.getElementById('analisePercParcelamento').textContent = percParcelamento.toFixed(1) + '%';

            // Velocidade de Vendas
            const diasOperacao = compras.length > 0 ? Math.ceil((hoje - new Date(compras[0].data)) / (1000 * 60 * 60 * 24)) : 0;
            const vendasPorDia = diasOperacao > 0 ? (unidadesVendidas / diasOperacao).toFixed(1) : 0;
            const tempoEstoque = unidadesVendidas > 0 ? (diasOperacao / unidadesVendidas).toFixed(0) : '-';
            const prazoEsgotar = vendasPorDia > 0 && estoqueAtual > 0 ? Math.ceil(estoqueAtual / vendasPorDia) : '-';
            const statusEstoque = estoqueAtual === 0 ? 'Esgotado' : estoqueAtual < 50 ? 'Baixo' : estoqueAtual < 200 ? 'Normal' : 'Alto';
            
            document.getElementById('analiseTempoEstoque').textContent = tempoEstoque + ' dias';
            document.getElementById('analiseVendasDia').textContent = vendasPorDia + ' un/dia';
            document.getElementById('analisePrazoEsgotar').textContent = prazoEsgotar + (prazoEsgotar !== '-' ? ' dias' : '');
            document.getElementById('analiseStatusEstoque').textContent = statusEstoque;

            // An√°lise Temporal
            document.getElementById('analiseDiasOperacao').textContent = diasOperacao + ' dias';
            const receitaDiaria = diasOperacao > 0 ? (totalReceita / diasOperacao) : 0;
            const lucroDiario = diasOperacao > 0 ? (totalLucro / diasOperacao) : 0;
            document.getElementById('analiseReceitaDiaria').textContent = formatarMoeda(receitaDiaria);
            document.getElementById('analiseLucroDiario').textContent = formatarMoeda(lucroDiario);
            
            // Crescimento (simplificado - comparar m√™s atual vs anterior)
            const crescimento = 0; // Ser√° calculado quando tiver mais dados hist√≥ricos
            document.getElementById('analiseCrescimento').textContent = crescimento.toFixed(1) + '%';

            // An√°lise de Pagamentos
            const parcelasVencidas = parcelas.filter(p => p.status === 'Pendente' && new Date(p.vencimento) < hoje);
            const valorInadimplencia = parcelasVencidas.reduce((acc, p) => acc + p.valor, 0);
            const prazoMedio = parcelas.length > 0 ? 30 : 0; // Simplificado
            const taxaAdimplencia = parcelas.length > 0 ? ((parcelas.length - parcelasVencidas.length) / parcelas.length * 100) : 100;
            
            document.getElementById('analisePrazoMedio').textContent = prazoMedio + ' dias';
            document.getElementById('analiseInadimplencia').textContent = formatarMoeda(valorInadimplencia);
            document.getElementById('analiseParcelasVencidas').textContent = parcelasVencidas.length;
            document.getElementById('analiseTaxaAdimplencia').textContent = taxaAdimplencia.toFixed(1) + '%';

            // Metas e Proje√ß√µes
            const metaMensal = totalLucro > 0 ? totalLucro * 1.2 : totalInvestido * 0.15; // Meta: 20% acima do atual
            const projecaoAnual = lucroMesAtual * 12;
            const breakeven = totalInvestido > 0 && lucroMesAtual > 0 ? (totalInvestido / lucroMesAtual).toFixed(1) : '-';
            const eficiencia = totalInvestido > 0 ? ((totalRecebido / totalInvestido) * 100) : 0;
            
            document.getElementById('analiseMetaMensal').textContent = formatarMoeda(metaMensal);
            document.getElementById('analiseProjecaoAnual').textContent = formatarMoeda(projecaoAnual);
            document.getElementById('analiseBreakeven').textContent = breakeven + (breakeven !== '-' ? ' meses' : '');
            document.getElementById('analiseEficiencia').textContent = eficiencia.toFixed(1) + '%';

            // Atualizar gr√°fico de barras
            const maxValor = Math.max(totalInvestido, totalReceita, totalLucro);
            const alturaInvestimento = maxValor > 0 ? (totalInvestido / maxValor * 100) : 0;
            const alturaReceita = maxValor > 0 ? (totalReceita / maxValor * 100) : 0;
            const alturaLucro = maxValor > 0 ? (Math.abs(totalLucro) / maxValor * 100) : 0;

            document.getElementById('barInvestimento').style.height = alturaInvestimento + '%';
            document.getElementById('barReceita').style.height = alturaReceita + '%';
            document.getElementById('barLucro').style.height = alturaLucro + '%';
            
            document.getElementById('valorBarInvestimento').textContent = formatarMoeda(totalInvestido);
            document.getElementById('valorBarReceita').textContent = formatarMoeda(totalReceita);
            document.getElementById('valorBarLucro').textContent = formatarMoeda(totalLucro);

            if (totalLucro < 0) {
                document.getElementById('barLucro').style.background = 'var(--danger)';
            }
        }

        // Criar Gr√°ficos
        let graficoLucro, graficoDistrib, graficoPerf;
        
        function criarGraficos() {
            // Destruir gr√°ficos antigos se existirem
            if (graficoLucro) graficoLucro.destroy();
            if (graficoDistrib) graficoDistrib.destroy();
            if (graficoPerf) graficoPerf.destroy();
            
            // Gr√°fico de Evolu√ß√£o do Lucro (√∫ltimos 6 meses)
            const ctxLucro = document.getElementById('graficoLucroMensal');
            if (ctxLucro) {
                const hoje = new Date();
                const meses = [];
                const lucros = [];
                
                for (let i = 5; i >= 0; i--) {
                    const mes = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                    const mesNome = mes.toLocaleDateString('pt-BR', { month: 'short' });
                    meses.push(mesNome);
                    
                    // Calcular lucro do m√™s
                    let lucroMes = 0;
                    parcelas.forEach(p => {
                        if (p.status === 'Pago' && p.dataPagamento) {
                            const dataPgto = new Date(p.dataPagamento);
                            if (dataPgto.getMonth() === mes.getMonth() && dataPgto.getFullYear() === mes.getFullYear()) {
                                lucroMes += (p.lucroParcela || 0);
                            }
                        }
                    });
                    lucros.push(lucroMes);
                }
                
                graficoLucro = new Chart(ctxLucro, {
                    type: 'line',
                    data: {
                        labels: meses,
                        datasets: [{
                            label: 'Lucro Mensal',
                            data: lucros,
                            borderColor: '#F7B801',
                            backgroundColor: 'rgba(247, 184, 1, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#6C757D' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                ticks: { color: '#6C757D' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de Distribui√ß√£o de Vendas (Pizza)
            const ctxDistrib = document.getElementById('graficoDistribuicao');
            if (ctxDistrib) {
                const vendasVista = vendas.filter(v => v.tipoPagamento === 'vista').length;
                const vendasParceladas = vendas.filter(v => v.tipoPagamento === 'parcelado').length;
                
                graficoDistrib = new Chart(ctxDistrib, {
                    type: 'doughnut',
                    data: {
                        labels: ['√Ä Vista', 'Parcelado'],
                        datasets: [{
                            data: [vendasVista, vendasParceladas],
                            backgroundColor: ['#06D6A0', '#F7B801'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#F7F9FB', padding: 15 }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de Performance por Per√≠odo (Barras)
            const ctxPerf = document.getElementById('graficoPerformance');
            if (ctxPerf) {
                const totalInvestido = compras.reduce((acc, c) => acc + c.valorTotal, 0);
                const totalReceita = vendas.reduce((acc, v) => acc + v.valorTotal, 0);
                const totalLucro = totalReceita - (totalInvestido / compras.reduce((acc, c) => acc + c.quantidade, 0) * vendas.reduce((acc, v) => acc + v.quantidade, 0));
                
                graficoPerf = new Chart(ctxPerf, {
                    type: 'bar',
                    data: {
                        labels: ['Investimento', 'Receita', 'Lucro'],
                        datasets: [{
                            label: 'Valores',
                            data: [totalInvestido, totalReceita, totalLucro],
                            backgroundColor: ['#EF476F', '#06D6A0', '#F7B801'],
                            borderWidth: 0,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { 
                                    color: '#6C757D',
                                    callback: function(value) {
                                        return 'R$ ' + (value/1000).toFixed(0) + 'k';
                                    }
                                },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                ticks: { color: '#6C757D' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        }

        // Formatar moeda SEM centavos
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor);
        }

        // Formatar moeda COM centavos (quando necess√°rio em casos espec√≠ficos)
        function formatarMoedaComCentavos(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(valor);
        }

        // Exportar dados
        function exportarDados() {
            const dados = {
                compras: compras,
                vendas: vendas,
                parcelas: parcelas,
                inflacao: inflacao,
                percentualImpostos: percentualImpostos || 0,
                exportadoEm: new Date().toISOString(),
                versao: '2.0'
            };

            const jsonString = JSON.stringify(dados, null, 2);
            
            // M√©todo 1: Tentar download direto
            try {
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gestao-j16-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                setTimeout(() => {
                    alert(`‚úÖ Dados exportados com sucesso!\n\n` +
                          `üìä Compras: ${compras.length}\n` +
                          `üìä Vendas: ${vendas.length}\n` +
                          `üìä Parcelas: ${parcelas.length}\n\n` +
                          `Arquivo salvo em Downloads!`);
                }, 500);
                
            } catch (error) {
                // M√©todo 2: Copiar para √°rea de transfer√™ncia
                console.error('Download bloqueado, usando m√©todo alternativo:', error);
                
                navigator.clipboard.writeText(jsonString).then(() => {
                    alert(`üìã Dados copiados para √°rea de transfer√™ncia!\n\n` +
                          `PASSOS:\n` +
                          `1. Abra o Bloco de Notas\n` +
                          `2. Cole (Ctrl+V)\n` +
                          `3. Salve como: backup-j16.json\n\n` +
                          `üìä Compras: ${compras.length}\n` +
                          `üìä Vendas: ${vendas.length}\n` +
                          `üìä Parcelas: ${parcelas.length}`);
                }).catch(() => {
                    // M√©todo 3: Mostrar em modal para copiar manualmente
                    mostrarDadosParaCopiar(jsonString);
                });
            }
        }

        // Mostrar dados em modal para c√≥pia manual
        function mostrarDadosParaCopiar(jsonString) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                max-width: 80%;
                max-height: 80%;
                overflow: auto;
            `;
            
            content.innerHTML = `
                <h2 style="color: #333; margin-bottom: 20px;">üìã Copie os dados abaixo:</h2>
                <textarea 
                    id="dadosExport" 
                    style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; padding: 10px;"
                    readonly
                >${jsonString}</textarea>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="copiarTexto()" style="padding: 10px 20px; margin-right: 10px; cursor: pointer; background: #06D6A0; color: white; border: none; border-radius: 5px;">
                        üìã Copiar Tudo
                    </button>
                    <button onclick="fecharModal()" style="padding: 10px 20px; cursor: pointer; background: #EF476F; color: white; border: none; border-radius: 5px;">
                        ‚úñ Fechar
                    </button>
                </div>
                <p style="color: #666; margin-top: 15px; font-size: 13px;">
                    <strong>Passos:</strong><br>
                    1. Clique em "Copiar Tudo"<br>
                    2. Abra o Bloco de Notas<br>
                    3. Cole (Ctrl+V)<br>
                    4. Salve como: <strong>backup-j16.json</strong>
                </p>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            window.copiarTexto = () => {
                const textarea = document.getElementById('dadosExport');
                textarea.select();
                document.execCommand('copy');
                alert('‚úÖ Dados copiados!\n\nAgora cole no Bloco de Notas e salve como .json');
            };
            
            window.fecharModal = () => {
                document.body.removeChild(modal);
                delete window.copiarTexto;
                delete window.fecharModal;
            };
            
            // Selecionar texto automaticamente
            setTimeout(() => {
                document.getElementById('dadosExport').select();
            }, 100);
        }

        // Importar dados
        function importarDados() {
            document.getElementById('fileImport').click();
        }

        // Processar importa√ß√£o
        function processarImportacao(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    
                    if (confirm(`üì• Importar dados do backup?\n\n` +
                               `Isso ir√° SUBSTITUIR todos os dados atuais!\n\n` +
                               `‚úì Compras: ${dados.compras?.length || 0}\n` +
                               `‚úì Vendas: ${dados.vendas?.length || 0}\n` +
                               `‚úì Parcelas: ${dados.parcelas?.length || 0}\n\n` +
                               `Deseja continuar?`)) {
                        
                        // Importar dados
                        compras = dados.compras || [];
                        vendas = dados.vendas || [];
                        parcelas = dados.parcelas || [];
                        inflacao = dados.inflacao || Array(12).fill(0);
                        percentualImpostos = dados.percentualImpostos || 0;
                        
                        // Salvar no localStorage
                        localStorage.setItem('compras', JSON.stringify(compras));
                        localStorage.setItem('vendas', JSON.stringify(vendas));
                        localStorage.setItem('parcelas', JSON.stringify(parcelas));
                        localStorage.setItem('inflacao', JSON.stringify(inflacao));
                        localStorage.setItem('percentualImpostos', percentualImpostos.toString());
                        
                        // Atualizar interface
                        renderizarCompras();
                        renderizarVendas();
                        renderizarParcelas();
                        atualizarDashboard();
                        
                        alert(`‚úÖ Dados importados com sucesso!\n\n` +
                              `‚úì ${compras.length} compras carregadas\n` +
                              `‚úì ${vendas.length} vendas carregadas\n` +
                              `‚úì ${parcelas.length} parcelas carregadas\n\n` +
                              `Sistema atualizado!`);
                    }
                } catch (error) {
                    console.error('Erro ao importar:', error);
                    alert('‚ùå Erro ao importar dados!\n\nArquivo inv√°lido ou corrompido.\n\n' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Limpar input
            event.target.value = '';
        }

        // Limpar todos os dados
        function limparDados() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO! Isso ir√° apagar TODOS os dados (compras, vendas e parcelas).\n\nDeseja continuar?')) {
                if (confirm('Tem certeza? Esta a√ß√£o n√£o pode ser desfeita!')) {
                    localStorage.clear();
                    compras = [];
                    vendas = [];
                    parcelas = [];
                    inflacao = Array(12).fill(0);
                    
                    // Reinicializar com dados de exemplo
                    inicializarDados();
                    
                    // Atualizar todas as visualiza√ß√µes
                    renderizarCompras();
                    renderizarVendas();
                    renderizarParcelas();
                    atualizarDashboard();
                    
                    alert('‚úì Dados limpos com sucesso! Uma compra de exemplo foi adicionada.');
                    
                    // Redirecionar para dashboard
                    showSection('dashboard');
                }
            }
        }

        // ==========================================
        // FUN√á√ïES CLOUD BACKUP
        // ==========================================

        async function fazerLoginCloud() {
            if (!supabaseClient) {
                alert('‚ùå Funcionalidade Cloud n√£o dispon√≠vel.\n\nVerifique sua conex√£o com a internet e recarregue a p√°gina.');
                return false;
            }
            
            const email = prompt('Digite seu email para fazer backup na cloud:');
            if (!email) return;
            
            const password = prompt('Digite sua senha (m√≠nimo 6 caracteres):');
            if (!password) return;

            try {
                mostrarNotificacao('üîÑ Conectando √† cloud...');
                
                // Tentar fazer login
                let { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                // Se n√£o existir, criar conta
                if (error && error.message.includes('Invalid')) {
                    if (confirm('Conta n√£o encontrada. Deseja criar uma nova conta?')) {
                        const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
                            email: email,
                            password: password
                        });

                        if (signUpError) throw signUpError;
                        
                        mostrarNotificacao('‚úÖ Conta criada! Fazendo login...');
                        
                        // Fazer login ap√≥s criar
                        ({ data, error } = await supabaseClient.auth.signInWithPassword({
                            email: email,
                            password: password
                        }));
                    } else {
                        return;
                    }
                }

                if (error) throw error;

                usuarioCloud = data.user;
                console.log('‚úÖ Login cloud realizado:', usuarioCloud.email);
                mostrarNotificacao('‚úÖ Conectado √† cloud: ' + usuarioCloud.email);
                
                return true;
            } catch (error) {
                console.error('‚ùå Erro no login cloud:', error);
                alert('Erro ao conectar: ' + error.message);
                return false;
            }
        }

        async function fazerBackupCloud() {
            if (!supabaseClient) {
                alert('‚ùå Funcionalidade Cloud n√£o dispon√≠vel.\n\nVerifique sua conex√£o com a internet e recarregue a p√°gina.');
                return;
            }
            
            // Verificar se est√° logado
            if (!usuarioCloud) {
                const loginOk = await fazerLoginCloud();
                if (!loginOk) return;
            }

            if (confirm('üì§ Fazer backup de TODOS os dados para a cloud?\n\n' +
                       `Compras: ${compras.length}\n` +
                       `Vendas: ${vendas.length}\n` +
                       `Parcelas: ${parcelas.length}\n\n` +
                       'Isso ir√° SUBSTITUIR os dados na cloud.')) {
                
                try {
                    mostrarNotificacao('‚òÅÔ∏è Enviando dados para cloud...');
                    
                    // Corrigir IDs decimais das parcelas (se houver)
                    console.log('üîß Verificando e corrigindo IDs...');
                    parcelas.forEach(parcela => {
                        if (!Number.isInteger(parcela.id)) {
                            parcela.id = Math.floor(parcela.id);
                            console.log('  ‚úì ID corrigido:', parcela.id);
                        }
                    });
                    localStorage.setItem('parcelas', JSON.stringify(parcelas));

                    // 1. Backup das Compras
                    console.log('üì§ Enviando compras...');
                    for (const compra of compras) {
                        const { error } = await supabaseClient
                            .from('compras')
                            .upsert({
                                id: compra.id,
                                data: compra.data,
                                quantidade: compra.quantidade,
                                valor_unitario: compra.valorUnitario,
                                valor_total: compra.valorTotal,
                                fornecedor: compra.fornecedor || null,
                                user_id: usuarioCloud.id
                            });
                        
                        if (error) throw error;
                    }

                    // 2. Backup das Vendas
                    console.log('üì§ Enviando vendas...');
                    for (const venda of vendas) {
                        const { error } = await supabaseClient
                            .from('vendas')
                            .upsert({
                                id: venda.id,
                                data: venda.data,
                                quantidade: venda.quantidade,
                                valor_unitario: venda.valorUnitario,
                                valor_total: venda.valorTotal,
                                cliente: venda.cliente || null,
                                tipo_pagamento: venda.tipoPagamento,
                                num_parcelas: venda.numParcelas,
                                taxa_juros: venda.taxaJuros,
                                status: venda.status,
                                user_id: usuarioCloud.id
                            });
                        
                        if (error) throw error;
                    }

                    // 3. Backup das Parcelas
                    console.log('üì§ Enviando parcelas...');
                    for (const parcela of parcelas) {
                        const { error } = await supabaseClient
                            .from('parcelas')
                            .upsert({
                                id: parcela.id,
                                venda_id: parcela.vendaId,
                                cliente: parcela.cliente || null,
                                numero_parcela: parcela.numeroParcela,
                                total_parcelas: parcela.totalParcelas,
                                valor: parcela.valor,
                                custo_unitario: parcela.custoUnitario || null,
                                custo_parcela: parcela.custoParcela || null,
                                lucro_parcela: parcela.lucroParcela || null,
                                margem_parcela: parcela.margemParcela || null,
                                quantidade_vendida: parcela.quantidadeVendida || null,
                                vencimento: parcela.vencimento,
                                data_pagamento: parcela.dataPagamento || null,
                                status: parcela.status,
                                user_id: usuarioCloud.id
                            });
                        
                        if (error) throw error;
                    }

                    // 4. Backup das Configura√ß√µes (Impostos e Infla√ß√£o)
                    console.log('üì§ Enviando configura√ß√µes...');
                    
                    const { error: configError } = await supabaseClient
                        .from('configuracoes')
                        .upsert({
                            chave: 'percentual_impostos',
                            valor: percentualImpostos.toString(),
                            user_id: usuarioCloud.id
                        });

                    const { error: inflacaoError } = await supabaseClient
                        .from('configuracoes')
                        .upsert({
                            chave: 'inflacao',
                            valor: JSON.stringify(inflacao),
                            user_id: usuarioCloud.id
                        });

                    console.log('‚úÖ Backup conclu√≠do!');
                    mostrarNotificacao('‚úÖ Backup realizado com sucesso na cloud!');
                    
                    alert(`‚úÖ Backup conclu√≠do!\n\n` +
                          `‚úì ${compras.length} compras\n` +
                          `‚úì ${vendas.length} vendas\n` +
                          `‚úì ${parcelas.length} parcelas\n\n` +
                          `Seus dados est√£o seguros na cloud! ‚òÅÔ∏è`);

                } catch (error) {
                    console.error('‚ùå Erro no backup:', error);
                    alert('Erro ao fazer backup: ' + error.message);
                }
            }
        }

        async function restaurarDaCloud() {
            if (!supabaseClient) {
                alert('‚ùå Funcionalidade Cloud n√£o dispon√≠vel.\n\nVerifique sua conex√£o com a internet e recarregue a p√°gina.');
                return;
            }
            
            // Verificar se est√° logado
            if (!usuarioCloud) {
                const loginOk = await fazerLoginCloud();
                if (!loginOk) return;
            }

            if (confirm('üì• Restaurar dados da cloud?\n\n' +
                       '‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° SUBSTITUIR todos os dados locais pelos dados da cloud!\n\n' +
                       'Tem certeza?')) {
                
                try {
                    mostrarNotificacao('‚òÅÔ∏è Baixando dados da cloud...');

                    // 1. Restaurar Compras
                    console.log('üì• Baixando compras...');
                    const { data: comprasCloud, error: comprasError } = await supabaseClient
                        .from('compras')
                        .select('*')
                        .eq('user_id', usuarioCloud.id);

                    if (comprasError) throw comprasError;

                    compras = comprasCloud.map(c => ({
                        id: c.id,
                        data: c.data,
                        quantidade: c.quantidade,
                        valorUnitario: c.valor_unitario,
                        valorTotal: c.valor_total,
                        fornecedor: c.fornecedor
                    }));

                    // 2. Restaurar Vendas
                    console.log('üì• Baixando vendas...');
                    const { data: vendasCloud, error: vendasError } = await supabaseClient
                        .from('vendas')
                        .select('*')
                        .eq('user_id', usuarioCloud.id);

                    if (vendasError) throw vendasError;

                    vendas = vendasCloud.map(v => ({
                        id: v.id,
                        data: v.data,
                        quantidade: v.quantidade,
                        valorUnitario: v.valor_unitario,
                        valorTotal: v.valor_total,
                        cliente: v.cliente,
                        tipoPagamento: v.tipo_pagamento,
                        numParcelas: v.num_parcelas,
                        taxaJuros: v.taxa_juros,
                        status: v.status
                    }));

                    // 3. Restaurar Parcelas
                    console.log('üì• Baixando parcelas...');
                    const { data: parcelasCloud, error: parcelasError } = await supabaseClient
                        .from('parcelas')
                        .select('*')
                        .eq('user_id', usuarioCloud.id);

                    if (parcelasError) throw parcelasError;

                    parcelas = parcelasCloud.map(p => ({
                        id: p.id,
                        vendaId: p.venda_id,
                        cliente: p.cliente,
                        numeroParcela: p.numero_parcela,
                        totalParcelas: p.total_parcelas,
                        valor: p.valor,
                        custoUnitario: p.custo_unitario,
                        custoParcela: p.custo_parcela,
                        lucroParcela: p.lucro_parcela,
                        margemParcela: p.margem_parcela,
                        quantidadeVendida: p.quantidade_vendida,
                        vencimento: p.vencimento,
                        dataPagamento: p.data_pagamento,
                        status: p.status
                    }));

                    // 4. Restaurar Configura√ß√µes
                    console.log('üì• Baixando configura√ß√µes...');
                    const { data: configs, error: configsError } = await supabaseClient
                        .from('configuracoes')
                        .select('*')
                        .eq('user_id', usuarioCloud.id);

                    if (!configsError && configs) {
                        configs.forEach(config => {
                            if (config.chave === 'percentual_impostos') {
                                percentualImpostos = parseFloat(config.valor) || 0;
                            }
                            if (config.chave === 'inflacao') {
                                inflacao = JSON.parse(config.valor);
                            }
                        });
                    }

                    // Salvar no localStorage
                    localStorage.setItem('compras', JSON.stringify(compras));
                    localStorage.setItem('vendas', JSON.stringify(vendas));
                    localStorage.setItem('parcelas', JSON.stringify(parcelas));
                    localStorage.setItem('percentualImpostos', percentualImpostos.toString());
                    localStorage.setItem('inflacao', JSON.stringify(inflacao));

                    // Atualizar interface
                    renderizarCompras();
                    renderizarVendas();
                    renderizarParcelas();
                    atualizarDashboard();

                    console.log('‚úÖ Restaura√ß√£o conclu√≠da!');
                    mostrarNotificacao('‚úÖ Dados restaurados da cloud com sucesso!');
                    
                    alert(`‚úÖ Restaura√ß√£o conclu√≠da!\n\n` +
                          `‚úì ${compras.length} compras\n` +
                          `‚úì ${vendas.length} vendas\n` +
                          `‚úì ${parcelas.length} parcelas\n\n` +
                          `Dados sincronizados! üéâ`);

                } catch (error) {
                    console.error('‚ùå Erro na restaura√ß√£o:', error);
                    alert('Erro ao restaurar dados: ' + error.message);
                }
            }
        }

        async function verificarStatusCloud() {
            if (!supabaseClient) {
                alert('‚ùå Funcionalidade Cloud n√£o dispon√≠vel.\n\nVerifique sua conex√£o com a internet e recarregue a p√°gina.');
                return;
            }
            
            if (!usuarioCloud) {
                alert('‚ÑπÔ∏è Cloud Backup Dispon√≠vel\n\n' +
                      'Voc√™ pode fazer backup dos seus dados na nuvem!\n\n' +
                      'Clique em "‚òÅÔ∏è Backup para Cloud" para come√ßar.');
                return;
            }

            try {
                mostrarNotificacao('üîç Verificando cloud...');

                // Contar registros na cloud
                const { count: comprasCount } = await supabaseClient
                    .from('compras')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', usuarioCloud.id);

                const { count: vendasCount } = await supabaseClient
                    .from('vendas')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', usuarioCloud.id);

                const { count: parcelasCount } = await supabaseClient
                    .from('parcelas')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', usuarioCloud.id);

                alert(`üìä Status Cloud Backup\n\n` +
                      `üë§ Usu√°rio: ${usuarioCloud.email}\n\n` +
                      `‚òÅÔ∏è Na Cloud:\n` +
                      `‚Ä¢ ${comprasCount || 0} compras\n` +
                      `‚Ä¢ ${vendasCount || 0} vendas\n` +
                      `‚Ä¢ ${parcelasCount || 0} parcelas\n\n` +
                      `üíæ Local:\n` +
                      `‚Ä¢ ${compras.length} compras\n` +
                      `‚Ä¢ ${vendas.length} vendas\n` +
                      `‚Ä¢ ${parcelas.length} parcelas`);

            } catch (error) {
                console.error('‚ùå Erro ao verificar status:', error);
                alert('Erro ao verificar status: ' + error.message);
            }
        }

        // ==========================================
        // FIM DAS FUN√á√ïES CLOUD
        // ==========================================

        // Carregar infla√ß√£o salva e renderizar ao iniciar
        window.addEventListener('load', () => {
            console.log('üöÄ Sistema de Gest√£o J16 Tracker Iniciado!');
            console.log('================================================');
            
            inflacao.forEach((valor, index) => {
                const input = document.getElementById(`ipca-${index}`);
                if (input && valor !== 0) {
                    input.value = valor;
                }
            });

            renderizarCompras();
            renderizarVendas();
            renderizarParcelas();
            atualizarDashboard();
            inicializarGraficos();
            
            console.log('================================================');
            console.log('‚úÖ Sistema carregado e pronto para uso!');
            console.log('üí° Dica: Abra o Dashboard para ver o resumo financeiro completo');
        });
    </script>
</body>
</html>
